import time

import allure

from base_page.base_page_locators import BaseOpenLocators
from open_pages.design_condition_page.design_condition_locators import DesignConditionLocators
from open_pages.kp_ridan_page.kp_ridan_locators import KpRidanLocators
from open_pages.standart_order_page.standart_order_locators import StandardOrderLocators, \
    OrderSuccessPageLocators
from open_pages.standart_order_page.standart_order_page import StandardOrderPage


@allure.feature('Страница КП Ридан')
class KpRidanPage(StandardOrderPage):
    """Страница КП Ридан"""

    def click_btn_add_a_discount_by_gcm(self):
        """Клик по кнопке Внести скидку по ГЦМ"""
        with allure.step('Клик по кнопке Внести скидку по ГЦМ'):
            btn_calculate_cost_delivery = self.find_element(StandardOrderLocators.LOCATOR_BTN_CALCULATE_COST_DELIVERY)
            self.scroll_to(btn_calculate_cost_delivery)
            self.waiting_element_is_visibility_on_the_page(KpRidanLocators.LOCATOR_BTN_ADD_A_DISCOUNT_BY_GCM)
            btn_add_a_discount_by_gcm = self.find_element(KpRidanLocators.LOCATOR_BTN_ADD_A_DISCOUNT_BY_GCM)
            btn_add_a_discount_by_gcm.click()
            self.waiting_element_is_visibility_located_dom(
                KpRidanLocators.LOCATOR_HEADER_IN_MODAL_ENTERING_A_DISCOUNT_ON_GCM, sec=5)

    def saving_negotiated_discount_in_modal_for_entering_discounts_on_gcm(self) -> float:
        """Сохранение договорной скидки в модалке внесения скидок по ГЦМ"""
        with allure.step('Сохранение договорной скидки в модалке внесения скидок по ГЦМ'):
            self.waiting_element_is_visibility_on_the_page(
                KpRidanLocators.LOCATOR_NEGOTIABLE_DISCOUNT_IN_DISCOUNT_MODAL, sec=5)
            negotiated_discount = self.find_element(KpRidanLocators.LOCATOR_NEGOTIABLE_DISCOUNT_IN_DISCOUNT_MODAL).text
            return float(negotiated_discount)

    def you_cannot_enter_more_than_contractual_discount_into_requested_discount(self, negotiable_discount: float
                                                                                ) -> None:
        """В запрашиаемую скидку нельзя внести больше договорной
        negotiable_discount - доворная скидка
        """
        with allure.step('В запрашиаемую скидку нельзя внести больше договорной'):
            negotiable_discount = int(negotiable_discount)
            self.waiting_element_is_visibility_on_the_page(
                KpRidanLocators.LOCATOR_NEGOTIABLE_DISCOUNT_IN_DISCOUNT_MODAL, sec=5)
            discount_to_enter = negotiable_discount + 2
            input_requested_discount = self.find_element(KpRidanLocators.LOCATOR_REQUESTED_DISCOUNT_IN_DISCOUNT_MODAL)
            input_requested_discount.send_keys(discount_to_enter)
            discount_in_requested_discount_field = int(input_requested_discount.get_attribute('value'))
            assert negotiable_discount == discount_in_requested_discount_field, \
                f'Запрашиваемая скидка - ({discount_in_requested_discount_field}) не равна договорной - ' \
                f'({negotiable_discount}) после внесения запрашиваемой скидки - ({discount_to_enter}), ' \
                f'большей чем договрная.'

    def click_btn_confirmation_in_modal_making_discounts(self):
        """Клик по кнопке Подтвердить в модалке внесения скидок"""
        with allure.step('Клик по кнопке Подтвердить в модалке внесения скидок'):
            self.waiting_element_is_visibility_on_the_page(
                KpRidanLocators.LOCATOR_BTN_CONFIRMATION_IN_MODAL_MAKING_DISCOUNTS, sec=5)
            btn_confirmation = self.find_element(KpRidanLocators.LOCATOR_BTN_CONFIRMATION_IN_MODAL_MAKING_DISCOUNTS)
            btn_confirmation.click()
            self.waiting_element_invisibility(KpRidanLocators.LOCATOR_HEADER_IN_MODAL_ENTERING_A_DISCOUNT_ON_GCM, sec=5)

    def save_discount_requested_on_page_confirmation(self) -> list:
        """Сохранение запрашиваемой скидки на странице Подтверждение"""
        with allure.step('Сохранение запрашиваемой скидки на странице Подтверждение'):
            self.waiting_element_is_visibility_located_dom(KpRidanLocators.LOCATOR_INPUT_DISCOUNT_REQUESTED)
            discount_requested = self.find_elements(KpRidanLocators.LOCATOR_INPUT_DISCOUNT_REQUESTED)
            discount_requested = [float(discount.get_attribute('value')) for discount in discount_requested]
            return discount_requested

    def click_confirmation_button(self):
        """Клик по кнопке Подтвердить"""
        with allure.step('Клик по кнопке Подтвердить'):
            button_confirmation = self.find_element(StandardOrderLocators.LOCATOR_BUTTON_CONFIRMATION)
            self.driver.execute_script("arguments[0].click()", button_confirmation)

            self.waiting_element_is_visibility_located_dom(KpRidanLocators.LOCATOR_HEADER_POSTED_KP, 60)

    def click_num_pq_on_order_placed_page(self):
        """Клик по номеру PQ в модалке после подтверждения заказа"""
        with allure.step('Клик по номеру PQ в модалке после подтверждения заказа'):
            num_pq_click = self.find_element(OrderSuccessPageLocators.LOCATOR_NUM_PQ_IN_MODAL)
            self.driver.execute_script("arguments[0].click()", num_pq_click)
            time.sleep(1)
            self.switching_window(-1)
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(DesignConditionLocators.LOCATOR_HEADER)

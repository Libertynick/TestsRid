import time

import allure
from selenium.webdriver.common.by import By

from base_page.base_page import BasePage
from open_pages.purchase_order_page.purchase_order_page_locators import PurchaseOrderPageLocators
from open_pages.purchase_orders_list_page.purchase_orders_list_locators import PurchaseOrdersListPageLocators


@allure.feature('Страница Список входящих заявок на покупку')
class PurchaseOrdersListPage(BasePage):
    """Страница Список входящих заявок на покупку"""

    def click_on_the_advanced_search_button(self):
        """Клик по кнопке Расширенный поиск"""
        with allure.step('Клик по кнопке Расширенный поиск'):
            button_advanced_search = self.find_element(PurchaseOrdersListPageLocators.LOCATOR_BUTTON_ADVANCED_SEARCH)
            self.click_js(button_advanced_search)
            self.waiting_element_is_visibility_located_dom(
                PurchaseOrdersListPageLocators.LOCATOR_OPEN_ADVANCED_SEARCH_FORM)

    def search_application(self, num_application: str):
        """Поиск заявки
        num_application - номер заявки
        """
        with allure.step(f'Поиск заявки {num_application}'):
            locator_found_application = (By.XPATH, f"//div[@class='bold' and contains(text(), '{num_application}')]"
                                         )  # Локатор найденной заявки
        self.click_on_the_advanced_search_button()

        input_num_application = self.find_element(PurchaseOrdersListPageLocators.LOCATOR_INPUT_APPLICATION_NUMBER)
        input_num_application.clear()
        input_num_application.send_keys(num_application)
        button_search = self.find_element(PurchaseOrdersListPageLocators.LOCATOR_BUTTON_SEARCH)
        self.click_js(button_search)
        time.sleep(1)
        self.waiting_element_is_visibility_located_dom(PurchaseOrdersListPageLocators.LOCATOR_BODY_NO_LOADER)
        time.sleep(0.5)
        self.waiting_element_is_visibility_on_the_page(locator_found_application)

    def go_to_application_by_number(self, num_application: str):
        """Переход в заявку по номеру
        num_application - номер заявки
        """
        with allure.step(f'Переход в заявку по номеру {num_application}'):
            locator_application = (By.XPATH, f"//div[@class='bold' and contains(text(), '{num_application}')]")
            application = self.find_element(locator_application)
            self.click_js(application)
            time.sleep(1)
            self.waiting_element_is_visibility_located_dom(PurchaseOrderPageLocators.LOCATOR_BODY, sec=50)
            header_on_page = self.find_element(PurchaseOrderPageLocators.LOCATOR_H1).text.strip()
            true_header = f'Заявка на покупку {num_application}'
            assert header_on_page == true_header, f'Открылась страница не с той заявкой - ({header_on_page}); ' \
                                                  f'ожидаемая заявка - ({true_header})'

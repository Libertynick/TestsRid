import allure

from base_page.base_page import BasePage

from base_page.base_page_locators import BaseOpenLocators
from open_pages.distr_and_service_partners_page.distr_and_service_partners_locators import \
    DistrAndServicePartnersLocators


@allure.feature('Страница Дистрибьюторы и сервисные партнеры')
class DistrAndServicePartners(BasePage):
    """Страница Дистрибьюторы и сервисные партнеры"""

    def find_distr_address(self, region: str):
        """Выбор адреса"""
        with allure.step('Выбор адреса'):
            field_address = self.find_element(DistrAndServicePartnersLocators.LOCATOR_REGION_DROP_UL)
            field_address.click()
            self.waiting_element_is_visibility_on_the_page(
                DistrAndServicePartnersLocators.locator_item_in_all_drop_ul(region)).click()

            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)

            entered_address = field_address.get_attribute('value')
            assert region == entered_address, \
                f'Выбранный адрес - ({entered_address}) не соответствует ожидаемому - ({region})'

    def choose_a_direction(self, value_direction: str):
        """Выбор направления"""
        with allure.step('Выбор направления'):
            self.waiting_element_is_visibility_located_dom(
                DistrAndServicePartnersLocators.LOCATOR_CHOOSE_A_DIRECTION_DROP_UL)
            field_direction = self.find_element(DistrAndServicePartnersLocators.LOCATOR_CHOOSE_A_DIRECTION_DROP_UL)
            field_direction.click()
            self.waiting_element_is_visibility_on_the_page(
                DistrAndServicePartnersLocators.locator_item_in_all_drop_ul(value_direction)
            ).click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            direction_entered_field = field_direction.get_attribute('value')
            assert direction_entered_field == value_direction, \
                f'Выбранное направление - ({direction_entered_field}) не соответствует ожидаемому - ({value_direction})'

    def click_btn_reload_list_distributor(self):
        """Клик по кнопке Обновление списка дистрибьюторов"""
        with allure.step('Клик по кнопке Обновление списка дистрибьюторов'):
            self.expecting_clickability(DistrAndServicePartnersLocators.LOCATOR_BUTTON_RELOAD_DISTR_LIST, sec=5)
            btn_reload_list_distributor = self.find_element(
                DistrAndServicePartnersLocators.LOCATOR_BUTTON_RELOAD_DISTR_LIST)
            btn_reload_list_distributor.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT, sec=30)

    def checking_display_of_distributors_by_region(self, expected_address: str):
        """Проверка работы фильтров"""
        with allure.step('Проверка работы фильтров'):
            self.waiting_element_is_visibility_on_the_page(
                DistrAndServicePartnersLocators.LOCATOR_ADDRESS_IN_DISTRIBUTOR_LIST, sec=5)
            address_distributor_list_on_page = self.find_elements(
                DistrAndServicePartnersLocators.LOCATOR_ADDRESS_IN_DISTRIBUTOR_LIST)
            address_distributor_list_on_page = [address.text for address in address_distributor_list_on_page]

            for address in address_distributor_list_on_page:
                assert expected_address in address, f'В результате поиска был найден дистрибьютор не с адресом из ' \
                                                    f'региона {expected_address}. Найденный адрес - ({address})'

    def expand_all_lists_with_contacts(self):
        """Развернуть все списки с контактами"""
        self.expecting_clickability(DistrAndServicePartnersLocators.LOCATOR_BTN_COLLAPSE_EXPAND_CONTACTS, sec=5)
        all_btn_expand_contact = self.find_elements(
            DistrAndServicePartnersLocators.LOCATOR_BTN_COLLAPSE_EXPAND_CONTACTS)
        for btn in all_btn_expand_contact:
            self.click_js(btn)
            expanded = btn.get_attribute('aria-expanded')
            assert expanded == 'true', f'Список контакты не открыт. aria-expanded - {expanded}'

import allure

from base_page.base_page import BasePage
from base_page.base_page_locators import BaseOpenLocators
from open_pages.balance_page.balance_page_locators import BalancePageLocators
from open_pages.calculations_of_ol_and_pto_page.calculations_of_ol_and_pto_locators import \
    CalculationsOfOlAndPtoLocators
from open_pages.my_design_conditions_page.my_design_conditions_locators import MyDesignConditionsLocators
from open_pages.header.header_locators import HeaderLocators, ProfileMenuUserLocators
from open_pages.objects_page.fastening_requests.locators_fastening_requests import FasteningRequestsLocators
import time

from open_pages.objects_page.free_jbjects.locators_free_objects import FreeObjectsLocators
from open_pages.order_list_page.order_list_page_locators import OrderListLocator
from open_pages.profile_page.profile_page_locators import ProfilePageLocators
from open_pages.purchase_orders_list_page.purchase_orders_list_locators import PurchaseOrdersListPageLocators
from open_pages.shipment_statuses_page.locators_shipment_statuses import ShipmentInStockLocators


class ProfileMenuUser(BasePage):
    """Выпадающее меню Профиль. Отображается на всех страницах авторизованного пользователя"""

    def click_profile(self):
        """Клик по кнопке Профиль"""
        with allure.step('Клик по кнопке Профиль'):
            self.waiting_element_is_visibility_on_the_page(HeaderLocators.LOCATOR_PROFILE_BUTTON, sec=10)
            button_profile = self.find_element(HeaderLocators.LOCATOR_PROFILE_BUTTON)
            self.click_js(button_profile)
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_UL_PROFILE_MENU)

    def click_btn_ul_orders(self):
        """Клик по кнопке выпадающего меню Заказы"""
        with allure.step('Клик по кнопке выпадающего меню Заказы'):
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BTN_UL_ORDERS)
            self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_ORDERS, sec=5)
            btn_orders = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_ORDERS)
            btn_orders.click()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_DIV_LIST_ITEM_ORDERS_MENU,
                                                           sec=5)

    def go_to_orders_menu_distributor(self):
        """Переход в заказы с выпадающего меню Профиль на учетке дистрибьютора"""
        with allure.step('Переход в заказы с выпадающего меню Профиль на учетке дистрибьютора'):
            with allure.step('Клик по кнопке Профиль'):
                self.click_profile()
                with allure.step('Клик по кнопке Заказы'):
                    self.click_btn_ul_orders()
                    self.expecting_clickability(ProfileMenuUserLocators.LOCATOR_ORDER_ITEM, sec=7)
                    item_order = self.find_element(ProfileMenuUserLocators.LOCATOR_ORDER_ITEM)
                    item_order.click()
                    self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
                    self.waiting_element_is_visibility_located_dom(OrderListLocator.LOCATOR_HEADING)

    def transition_to_purchase_orders_under_an_indirect_client(self):
        """Переход в Заявки на покупку под непрямым клиентом"""
        with allure.step('Переход в Заявки на покупку под непрямым клиентом'):
            self.click_profile()
            self.click_btn_ul_orders()
            item_order = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_PURCHASE_ORDERS)
            item_order.click()
            time.sleep(1)
            self.waiting_element_is_visibility_located_dom(PurchaseOrdersListPageLocators.LOCATOR_BODY_NO_LOADER,
                                                           sec=60)
            self.waiting_element_is_visibility_on_the_page(PurchaseOrdersListPageLocators.LOCATOR_H1)

    def go_to_shipments(self):
        """Переход на страницу Статусы отгрузок - на складе"""
        with allure.step('Переход в Заявки на покупку под непрямым клиентом'):
            self.click_profile()
            btn_ul_shipments = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_SHIPMENTS)
            btn_ul_shipments.click()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BTN_IN_STOCK, sec=5)
            item_shipments = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_IN_STOCK)
            item_shipments.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.is_element_present(*ShipmentInStockLocators.LOCATOR_HEADER_H1)

    def click_btn_ul_objects(self):
        """Клик по кнопке выпадающего меню Объекты"""
        with allure.step('Клик по кнопке выпадающего меню Объекты'):
            self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_OBJECTS, sec=5)
            btn_objects = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_OBJECTS)
            btn_objects.click()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BUTTON_PINNED_OBJECTS, sec=5)

    def go_to_free_object(self):
        """Переход в свободные объекты"""
        self.expecting_clickability(ProfileMenuUserLocators.LOCATOR_BTN_FREE_OBJECT, sec=5)
        btn_free_object = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_FREE_OBJECT)
        btn_free_object.click()
        self.waiting_element_is_visibility_on_the_page(FreeObjectsLocators.LOCATOR_H1_HEADER)

    def go_to_applications_for_fastening(self):
        """Переход на страницу Заявки на крепление"""
        with allure.step('Переход на страницу Заявки на крепление'):
            with allure.step('Клик по меню Профиль'):
                self.click_profile()
                with allure.step('Клик по Объекты'):
                    self.click_btn_ul_objects()
                    item_applications_for_fastening = self.find_element(
                        ProfileMenuUserLocators.LOCATOR_APPLICATIONS_FOR_FASTENING_ITEM)
                    item_applications_for_fastening.click()
                    self.waiting_for_loader_processing_in_dom(FasteningRequestsLocators.LOCATOR_LOADER_OLD)
                    self.is_element_present(*FasteningRequestsLocators.LOCATOR_H1_HEADER)

    def go_to_design_conditions(self):
        """Переход в Проектные условия"""
        with allure.step('Переход в Проектные условия'):
            self.click_btn_ul_orders()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_DESIGN_CONDITIONS)
            button_design_conditions = self.find_element(ProfileMenuUserLocators.LOCATOR_DESIGN_CONDITIONS)
            button_design_conditions.click()
            time.sleep(1)
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT, sec=90)
            self.waiting_element_is_visibility_on_the_page(MyDesignConditionsLocators.LOCATOR_H1_HEADER, sec=30)

    def click_btn_ul_calculations(self):
        """Клик по кнопке Выпадающего меню Расчеты"""
        with allure.step('Клик по кнопке Выпадающего меню Расчеты'):
            self.expecting_clickability(ProfileMenuUserLocators.LOCATOR_BTN_UL_CALCULATIONS)
            self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_CALCULATIONS, sec=5)
            btn_calculations = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_CALCULATIONS)
            btn_calculations.click()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BTN_CALCULATION_AND_OL_PTO,
                                                           sec=5)

    def go_to_page_calculations_and_ol_pto(self):
        """Переход на страницу Расчеты и ОЛ ПТО (Мои расчеты)"""
        with allure.step('Переход на страницу Расчеты и ОЛ ПТО (Мои расчеты)'):
            self.click_profile()
            self.click_btn_ul_calculations()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BTN_CALCULATION_AND_OL_PTO)
            button_my_calculations = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_CALCULATION_AND_OL_PTO)
            button_my_calculations.click()
            time.sleep(1)
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT, sec=90)
            self.waiting_element_is_visibility_on_the_page(CalculationsOfOlAndPtoLocators.LOCATOR_H1, sec=30)

    def logout(self):
        """Выход из учетки"""
        with allure.step('Выход из учетки'):
            self.expecting_clickability(ProfileMenuUserLocators.LOCATOR_BUTTON_LOGOUT, sec=5)
            button_logout = self.find_element(ProfileMenuUserLocators.LOCATOR_BUTTON_LOGOUT)
            self.click_js(button_logout)
            self.waiting_element_is_visibility_on_the_page(HeaderLocators.LOCATOR_TO_COME_IN_BUTTON, sec=30)

    def go_to_profile(self):
        """Переход в профиль"""
        with allure.step('Переход в Профиль'):
            self.click_profile()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_BTN_PROFILE)
            btn_profile = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_PROFILE)
            btn_profile.click()
            self.waiting_element_is_visibility_on_the_page(ProfilePageLocators.LOCATOR_HEADER)

    def save_user_name(self) -> str:
        """Сохранение имени пользователя"""
        with allure.step('Сохранение имени пользователя'):
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_NAME_USER, sec=5)
            user_name = self.find_element(ProfileMenuUserLocators.LOCATOR_NAME_USER).text
            return user_name

    def click_btn_ul_company(self):
        """Клик по кнопке выпадающего меню Компания"""
        with allure.step('Клик по кнопке выпадающего меню Компания'):
            self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_COMPANY, sec=5)
            btn_company = self.find_element(ProfileMenuUserLocators.LOCATOR_BTN_UL_COMPANY)
            btn_company.click()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_DIV_LIST_ITEM_COMPANY, sec=5)

    def go_to_queue_for_confirmation_to_company(self):
        """Переход в очередь на подтверждение в компанию"""
        with allure.step('Переход в очередь на подтверждение в компанию'):
            self.click_profile()
            self.click_btn_ul_company()
            self.waiting_element_is_visibility_on_the_page(
                ProfileMenuUserLocators.LOCATOR_BTN_QUEUE_FOR_CONFIRMATION_TO_COMPANY, sec=5)
            btn_queue_for_confirmation = self.find_element(
                ProfileMenuUserLocators.LOCATOR_BTN_QUEUE_FOR_CONFIRMATION_TO_COMPANY)
            btn_queue_for_confirmation.click()

    def go_to_changing_of_dates_of_the_order(self):
        """Переход в меню Изменение сроков в Заказе"""
        with allure.step('Переход в меню Изменение сроков в Заказе'):
            self.click_btn_ul_orders()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_CHANGING_OF_DATES)
            btn_changing_of_dates = self.find_element(ProfileMenuUserLocators.LOCATOR_CHANGING_OF_DATES)
            btn_changing_of_dates.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)

    def go_to_balance(self):
        """Переход в Баланс"""
        with allure.step('Переход в Баланс'):
            self.click_profile()
            self.waiting_element_is_visibility_on_the_page(ProfileMenuUserLocators.LOCATOR_ITEM_BALANCE_IN_MENU_PROFILE)
            btn_balance = self.find_element(ProfileMenuUserLocators.LOCATOR_ITEM_BALANCE_IN_MENU_PROFILE)
            btn_balance.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(BalancePageLocators.LOCATOR_HEADER)

import allure

from base_page.base_page import BasePage

from base_page.base_page_locators import BaseOpenLocators
from open_pages.order_details_page.order_details_page_locators import OrderDetailsLocators
from open_pages.order_list_page.order_list_page_locators import OrderListLocator


@allure.feature('Страница списка заказов')
class OrderList(BasePage):
    """Страница списка заказов"""

    def copy_last_order(self):
        """Копирование номера последнего заказа"""
        with allure.step('Копирование номера последнего заказа'):
            list_h2_empty = self.driver.find_elements(*OrderListLocator.LOCATOR_H2_LIST_EMPTY)
            if len(list_h2_empty) > 0:
                self.driver.refresh()
                self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_located_dom(OrderListLocator.LOCATOR_LIST_ORDERS_LINK_ON_ACCOUNT, sec=10)
            orders = self.driver.find_elements(*OrderListLocator.LOCATOR_LIST_ORDERS_LINK_ON_ACCOUNT)
            order = orders[0]
            return order.text

    def order_search_by_number_and_author(self, order: str):
        """Поиск заказа на странице Заказы
        order - номер заказа"""
        with allure.step('Поиск заказа на странице Заказы'):
            self.waiting_element_is_visibility_on_the_page(OrderListLocator.LOCATOR_INPUT_SEARCH, sec=15)
            input_search = self.find_element(OrderListLocator.LOCATOR_INPUT_SEARCH)
            input_search.clear()
            input_search.send_keys(order)
            button_search = self.find_element(OrderListLocator.LOCATOR_BUTTON_SEARCH)
            button_search.click()
            # self.driver.execute_script("arguments[0].click()", button_search)
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            res_search = self.driver.find_elements(*OrderListLocator.LOCATOR_ORDER_LINE)
            assert len(res_search) == 1, f'Не найдено ни одного заказа или количество найденных заказов больше 1. ' \
                                         f'Найдено заказов - ({len(res_search)})'

    def go_to_order(self, order: str):
        """Переход в заказ по номеру заказы
        order - номер заказа"""
        with allure.step('Переход в заказ по номеру заказы'):
            order_link = self.find_element(OrderListLocator.locator_link_to_order(order))
            self.driver.execute_script("arguments[0].click()", order_link)
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(OrderDetailsLocators.locator_header_order(order))

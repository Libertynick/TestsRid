import time

import allure
from selenium.common import TimeoutException

from base_page.base_page import BasePage
from base_page.base_page_locators import BaseOpenLocators
from open_pages.selection_online_tools_all.bhu_select.bhu_select_locators import BhuSelectLocators
from open_pages.selection_online_tools_all.clever_desk.clever_desk_locators import CleverDeskLocators
from open_pages.selection_online_tools_all.configurator_ppto.configurator_ppto_locators import ConfiguratorPptoLocators
from open_pages.selection_online_tools_all.cool_confi.cool_config_locators import CoolConfigLocators
from open_pages.selection_online_tools_all.heat_select_selection.heat_select_locators import HeatSelectLocators
from open_pages.selection_online_tools_all.selection_of_analogue_ridan_page.selection_of_analogue_ridan_locators import \
    SelectionOfAnalogueRidanLocators
from open_pages.selection_online_tools_all.selection_of_heating_device.selection_of_heating_device_locators import \
    HeatingDeviceLocators
from open_pages.selection_online_tools_all.selection_of_plate_heat_exchangers_ridan_page.selection_of_plate_heat_exchangers_ridan_page_locators \
    import SelectionOfPlateHeatExchangersRidanLocators
from open_pages.selection_online_tools_all.btp_selection.btp_selection_locators import BTPConfig, BTPDeviceLocators
from open_pages.selection_online_tools_all.pumping_station_configurator_page.pumping_station_configurator_locators import \
    PumpingStationConfiguratorLocators
from open_pages.selection_online_tools_all.sha_select_panel_config.selection_of_automation_cabinets_locators import \
    ShaSelectLocators
from open_pages.selection_online_tools_all.tdu_select.selection_of_tdu_distribution_unit_locators import \
    SelectionOfTduDistributionUnitLocators
from open_pages.selection_tools_modal.selection_tools_modal_locators import SelectionToolsModalLocators, \
    HexDesignLocators, HeatingStationChapterLocators, PumpTabLocators, TabHeatingAndHeatSupplyLocators
from open_pages.selection_online_tools_all.pump_selection.pump_select_locators import PumpLocators

"""Страница Подбор ПТО"""


@allure.feature('Модалка инструменты подбора')
class SelectionToolsModalPage(BasePage):
    """Модалка инструменты подбора"""

    def transition_chapter_heat_exchanger_selection(self):
        """Переход в раздел Подбор теплообменника"""
        with allure.step('Переход в раздел Подбор теплообменника'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_CHAPTER_HEAT_EXCHANGER_SELECTION, sec=5)
            btn_chapter_heat_exchanger_selection = self.find_element(
                SelectionToolsModalLocators.LOCATOR_CHAPTER_HEAT_EXCHANGER_SELECTION)
            btn_chapter_heat_exchanger_selection.click()
            self.waiting_element_is_visibility_on_the_page(HexDesignLocators.LOCATOR_HEADER, sec=5)

    def click_tab_air_conditioning_and_refrigeration(self):
        """Клик по вкладке Кондиционирование и холодоснабжение"""
        with allure.step('Клик по вкладке Кондиционирование и холодоснабжение'):
            self.expecting_clickability(
                SelectionToolsModalLocators.LOCATOR_BTN_TAB_AIR_CONDITIONING_AND_REFRIGERATION, sec=5)
            btn_tab_air_conditioning_and_refrigeration = self.find_element(
                SelectionToolsModalLocators.LOCATOR_BTN_TAB_AIR_CONDITIONING_AND_REFRIGERATION)
            btn_tab_air_conditioning_and_refrigeration.click()
            self.waiting_element_is_visibility_on_the_page(SelectionToolsModalLocators.LOCATOR_H3_BHU_SELECT, sec=5)

    def click_tab_pump(self):
        """Клик по вкладке Насосы"""
        with allure.step('Клик по вкладке Насосы'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_TAB_PUMP, sec=5)
            btn_tab_pump = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_TAB_PUMP)
            btn_tab_pump.click()
            self.waiting_element_is_visibility_on_the_page(PumpTabLocators.LOCATOR_H3_PUMP_SELECT, sec=5)

    def click_tab_heating_and_heat_supply(self):
        """Клик по вкладке Отопление и теплоснабжение"""
        with allure.step('Клик по вкладке Отопление и теплоснабжение'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_TAB_HEATING_AND_HEAT_SUPPLY, sec=5)
            btn_tab_heating_and_heat_supply = self.find_element(
                SelectionToolsModalLocators.LOCATOR_BTN_TAB_HEATING_AND_HEAT_SUPPLY)
            btn_tab_heating_and_heat_supply.click()
            self.waiting_element_is_visibility_on_the_page(TabHeatingAndHeatSupplyLocators.LOCATOR_HEADER_H3_DCAD,
                                                           sec=5)

    def click_tab_controllers(self):
        """Клик по вкладке Контроллеры"""
        with allure.step('Клик по вкладке Контроллеры'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_TAB_CONTROLLERS, sec=5)
            tab_controllers = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_TAB_CONTROLLERS)
            tab_controllers.click()
            self.waiting_element_is_visibility_on_the_page(SelectionToolsModalLocators.LOCATOR_H3_PANEL_CONFIG, sec=5)

    def click_tab_refrigeration_technology(self):
        """Клик по кнопке раздела Холодильная техника"""
        with allure.step('Клик по кнопке раздела Холодильная техника'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_TAB_REFRIGERATION_TECHNOLOGY, sec=5)
            tab_refrigeration_technology = self.find_element(
                SelectionToolsModalLocators.LOCATOR_BTN_TAB_REFRIGERATION_TECHNOLOGY)
            tab_refrigeration_technology.click()
            self.waiting_element_is_visibility_on_the_page(SelectionToolsModalLocators.LOCATOR_H3_COOL_CONFIG, sec=5)

    def go_to_heat_exchanger_selection(self):
        """Переход на 'Подбор теплообменника'"""
        with allure.step('Переход на Подбор теплообменника'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_HEAT_EXCHANGER_SELECTION_BUTTON)
            button_heat_exchanger = self.find_element(
                SelectionToolsModalLocators.LOCATOR_HEAT_EXCHANGER_SELECTION_BUTTON)
            button_heat_exchanger.click()
            self.is_element_present(*SelectionOfPlateHeatExchangersRidanLocators.LOCATOR_H1_HEADER)

    def go_to_water_jump_select(self):
        """Переход в Насосные станции, конфигуратор"""
        with allure.step('Переход в Насосные станции, конфигуратор'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_WATER_JUMP_SELECT)
            btn_water_jump_select = self.find_element(SelectionToolsModalLocators.LOCATOR_WATER_JUMP_SELECT)
            btn_water_jump_select.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(PumpingStationConfiguratorLocators.LOCATOR_HEADER)

    def go_to_brazed_heat_exchangers_configurator(self):
        """Переход в Паяные теплообменники, конфигуратор"""
        with allure.step('Переход в Паяные теплообменники, конфигуратор'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_BRAZED_HEAT_EXCHANGERS_CONFIGURATOR)
            btn_brazed_heat_exchangers_configurator = self.find_element(
                SelectionToolsModalLocators.LOCATOR_BTN_BRAZED_HEAT_EXCHANGERS_CONFIGURATOR)
            self.click_js(btn_brazed_heat_exchangers_configurator)
            self.waiting_element_is_visibility_on_the_page(ConfiguratorPptoLocators.LOCATOR_HEADER)

    def go_to_btp_select(self):
        """Переход на страницу подбора БТП"""
        with allure.step('Переход на страницу подбора БТП'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_BTP_SELECT)
            button_btp_select = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_BTP_SELECT)
            self.driver.execute_script("arguments[0].click()", button_btp_select)

            self.is_element_present(*BTPConfig.LOCATOR_FIRST_PAGE)
            button_calc_btp = self.find_element(BTPConfig.LOCATOR_BUTTON_CALCULATE_BTP)
            self.driver.execute_script("arguments[0].click()", button_calc_btp)
            self.switching_window(-1)
            self.waiting_element_is_visibility_on_the_page(BTPConfig.LOCATOR_BTN_RIDAN_HEAT_PLATFORM)
            time.sleep(1)

            self.waiting_element_is_visibility_located_dom(BTPConfig.LOCATOR_FRAME_SECOND_PAGE)
            iframe = self.find_element(BTPConfig.LOCATOR_FRAME_SECOND_PAGE)
            self.driver.switch_to.frame(iframe)
            try:
                button_close_masseg = self.find_element(BTPConfig.LOCATOR_INFORM_CLOSE)
                self.driver.execute_script("arguments[0].click()", button_close_masseg)
            except TimeoutException:
                self.driver.refresh()
                self.waiting_element_is_visibility_located_dom(BTPConfig.LOCATOR_FRAME_SECOND_PAGE)
                iframe = self.find_element(BTPConfig.LOCATOR_FRAME_SECOND_PAGE)
                self.driver.switch_to.frame(iframe)
                button_close_masseg = self.find_element(BTPConfig.LOCATOR_INFORM_CLOSE)
                self.driver.execute_script("arguments[0].click()", button_close_masseg)

            text_sec_page = self.find_element(BTPConfig.LOCATOR_SECOND_PAGE)
            self.driver.execute_script("arguments[0].click()", text_sec_page)

            self.is_element_present(*BTPConfig.LOCATOR_SECOND_PAGE)
            button_do_calc = self.find_element(BTPConfig.LOCATOR_BUTTON_SIMPLE_CALCULATE)
            self.driver.execute_script("arguments[0].click()", button_do_calc)

            self.is_element_present(*BTPDeviceLocators.LOCATOR_PAGE_SELECT)

    def go_to_tdu_select(self):
        """Переход в подбор ТДУ"""
        with allure.step('Переход в подбор ТДУ'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_TDU_SELECT)
            btn_tdu_select = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_TDU_SELECT)
            btn_tdu_select.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(SelectionOfTduDistributionUnitLocators.LOCATOR_HEADER,
                                                           sec=20)

    def go_to_bhu_select(self):
        """Переход в Подбор БХУ"""
        with allure.step('Переход в Подбор БХУ'):
            try:
                self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_BHU_SELECT,
                                            sec=5)
                btn_bhu_select = self.find_element(
                    SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_BHU_SELECT)
                btn_bhu_select.click()
                self.switching_window(-1)
                self.waiting_element_is_visibility_on_the_page(BhuSelectLocators.LOCATOR_BTN_LOG_IN, sec=5)
            except TimeoutException:
                self.driver.refresh()
                self.waiting_element_is_visibility_on_the_page(BhuSelectLocators.LOCATOR_BTN_LOG_IN, sec=10)

    def go_to_clever_desk(self):
        """Переход в Clever Desk"""
        with allure.step('Переход в Clever Desk'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_CLEVER_DESK)
            btn_tdu_select = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_CLEVER_DESK)
            btn_tdu_select.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(CleverDeskLocators.LOCATOR_HEADER_PAGE_CONFIG_CLEVER_DESK,
                                                           sec=20)

    def go_to_selection_of_analogue_ridan_equipment(self):
        """Переход в Подбор аналога оборудования Ридан"""
        with allure.step('Переход в Подбор аналога оборудования Ридан'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_SELECTION_OF_ANALOGUE_RIDAN_EQUIPMENT)
            btn_selection_of_analogue_ridan_equipment = self.find_element(
                SelectionToolsModalLocators.LOCATOR_BTN_SELECTION_OF_ANALOGUE_RIDAN_EQUIPMENT)
            btn_selection_of_analogue_ridan_equipment.click()
            self.waiting_element_is_visibility_on_the_page(SelectionOfAnalogueRidanLocators.LOCATOR_HEADER, sec=20)

    def go_to_sha_select(self):
        """Переход на страницу Подбора ША(шкафа автоматизации)"""
        with allure.step('Переход на страницу Подбора ША(шкафа автоматизации)'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_CONTROLLERS, sec=5)
            btn_bhu_select = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_CONTROLLERS)
            btn_bhu_select.click()
            self.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)
            self.waiting_element_is_visibility_on_the_page(ShaSelectLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR, sec=5)

    def go_to_cool_config(self):
        """Переход на страницу подбора Cool config"""
        with allure.step('Переход на страницу подбора Cool config'):
            self.expecting_clickability(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_COOL_CONFIG, sec=5)
            btn_cool_config = self.find_element(SelectionToolsModalLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_COOL_CONFIG)
            btn_cool_config.click()

            flag = False
            stop = 5
            while not flag:
                try:
                    self.waiting_element_is_visibility_located_dom(CoolConfigLocators.LOCATOR_FRAME)
                    self.switch_to_frame(CoolConfigLocators.LOCATOR_FRAME)
                    self.expecting_clickability(CoolConfigLocators.LOCATOR_MENU_CHOOSE_COOLING_DIAGRAMS, sec=30)
                    flag = True
                except TimeoutException:
                    self.driver.refresh()
                    # self.waiting_element_is_visibility_located_dom(CoolConfigLocators.LOCATOR_FRAME)
                    # self.switch_to_frame(CoolConfigLocators.LOCATOR_FRAME)
                    # self.expecting_clickability(CoolConfigLocators.LOCATOR_MENU_CHOOSE_COOLING_DIAGRAMS, sec=30)
                    stop -= 1
                    if stop == 0:
                        raise  # Поднимаем исключение


@allure.feature('Раздел Тепловой пункт')
class HeatingStationChapter(BasePage):
    """Раздел Тепловой пункт"""

    def go_to_selection_of_control_valves_and_direct_acting_regulators(self):
        """Переход в Подбор регулирующих клапанов и регуляторов прямого действия"""
        with allure.step('Переход в Подбор регулирующих клапанов и регуляторов прямого действия'):
            self.expecting_clickability(
                HeatingStationChapterLocators.LOCATOR_BTN_SELECTION_OF_CONTROL_VALVES_AND_DIRECT_ACTING_REGULATORS,
                sec=5)
            btn_selection_of_control_valves = self.find_element(
                HeatingStationChapterLocators.LOCATOR_BTN_SELECTION_OF_CONTROL_VALVES_AND_DIRECT_ACTING_REGULATORS)
            btn_selection_of_control_valves.click()
            self.waiting_element_is_visibility_on_the_page(HeatingStationChapterLocators.LOCATOR_H3_HEAT_SELECT, sec=5)

    def go_to_heat_select(self):
        """Переход на страницу подбора Heat Select"""
        with allure.step('Переход на страницу подбора Heat Select'):
            try:
                self.expecting_clickability(
                    HeatingStationChapterLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_HEAT_SELECT, sec=5)
                btn_heat_select = self.find_element(
                    HeatingStationChapterLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_HEAT_SELECT)
                btn_heat_select.click()
                self.waiting_element_is_visibility_located_dom(HeatSelectLocators.LOCATOR_FRAME_HP)
                self.switch_to_frame(HeatSelectLocators.LOCATOR_FRAME_HP)
                self.waiting_element_is_visibility_on_the_page(HeatSelectLocators.LOCATOR_HEADER_SELECT_TWO_WAY_VALVE)
            except TimeoutException:
                self.driver.refresh()
                self.switch_to_frame(HeatSelectLocators.LOCATOR_FRAME_HP)
                self.waiting_element_is_visibility_on_the_page(HeatSelectLocators.LOCATOR_HEADER_SELECT_TWO_WAY_VALVE,
                                                               sec=30)


class PumpChapter(BasePage):
    """Раздел Насосы"""

    def go_to_pump(self):
        """Переход на страницу подбора насосов"""
        with allure.step('Переход на страницу подбора насосов'):
            self.expecting_clickability(PumpTabLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_PUMP, sec=5)
            btn_go_to_configurator = self.find_element(PumpTabLocators.LOCATOR_BTN_GO_TO_CONFIGURATOR_PUMP)
            btn_go_to_configurator.click()
            self.waiting_element_is_visibility_on_the_page(PumpLocators.LOCATOR_H1_HEADER_PUMP)


@allure.feature('Раздел Отопление и теплоснабжение')
class HeatingAndHeatSupplyChapter(BasePage):
    """Раздел Отопление и теплоснабжение"""

    def click_btn_go_to_dcad(self):
        """Клик по кнопке Перейти DCAD"""
        # with allure.step('Клик по кнопке Перейти'):
        #     self.expecting_clickability(TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_GO_TO, sec=5)
        #     btn_go_to = self.find_element(TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_GO_TO)
        #     btn_go_to.click()
        #     self.waiting_element_is_visibility_on_the_page(HeatingDeviceLocators.) дописать сюда ожидание заголовка -
        #     не работал сайт во время написания данного метода

    def go_to_chapter_calculation_of_heating_device_power(self):
        """Переход в раздел Расчет мощности отопительного прибора"""
        with allure.step(''):
            self.expecting_clickability(
                TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_CHAPTER_CALCULATION_OF_HEATING_DEVICE_POWER, sec=5)
            btn_chapter_calculation_of_heating_device_power = self.find_element(
                TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_CHAPTER_CALCULATION_OF_HEATING_DEVICE_POWER)
            btn_chapter_calculation_of_heating_device_power.click()
            self.waiting_element_is_visibility_on_the_page(
                TabHeatingAndHeatSupplyLocators.LOCATOR_H3_HEADER_HEATING_DEVICE,
                sec=5)

    def click_btn_go_to_calculator_in_chapter_calculation_of_heating_device_power(self):
        """Клик по кнопке Перейти в калькулятор в разделе Расчет мощности отопительного прибора"""
        with allure.step('Клик по кнопке Перейти в калькулятор в разделе Расчет мощности отопительного прибора'):
            self.expecting_clickability(
                TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_GO_TO_CALCULATOR_CALCULATION_OF_HEATING_DEVICE_POWER, sec=5)
            btn_go_to_calculator = self.find_element(
                TabHeatingAndHeatSupplyLocators.LOCATOR_BTN_GO_TO_CALCULATOR_CALCULATION_OF_HEATING_DEVICE_POWER)
            btn_go_to_calculator.click()
            self.waiting_element_is_visibility_on_the_page(HeatingDeviceLocators.LOCATOR_H1_HEADER_HEATING_DEVICE,
                                                           sec=5)

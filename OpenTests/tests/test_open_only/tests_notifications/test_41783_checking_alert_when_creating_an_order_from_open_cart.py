import allure
import pytest

from config import TestEnvironment
from open_pages.cart_page.cart_page import CartPage
from open_pages.header.header_page import Header
from open_pages.main_page.main_page import MainPage
from open_pages.notifications_page.notifications_page import NotificationsPage
from open_pages.order_details_page.order_details_page import OrderDetails
from open_pages.standart_order_page.standart_order_page import StandardOrderPage

link_open = TestEnvironment.LINK_OPEN_TST
login_open = TestEnvironment.LOGIN_TST_VODOKOMFORT
password_open = TestEnvironment.PASSWORD_TST_VODOKOMFORT


def creation_kp(browser, article: str):
    page = MainPage(browser, link_open)
    page.open()
    page.authorization_from_main_page(login_open, password_open)

    page = Header(browser, link_open)
    page.click_basket()

    page = CartPage(browser, link_open)
    page.click_empty_trash()
    page.choice_of_client_number()
    page.type_product_in_input(article)
    page.click_add_button()
    page.click_continue_button()

    page = StandardOrderPage(browser, link_open)
    page.choice_of_payment_terms_prepayment()
    page.choice_of_delivery_method_pickup()
    page.click_confirmation_button()
    page.click_num_pq_on_order_placed_page()

    page = OrderDetails(browser, link_open)
    page.waiting_for_account_creation()
    num_order = page.store_num_order()
    return num_order


# Если нет уведомления о создании заказа - зайти в настройки уведомлений и проверить, что включен тумблер
# по уведомлениям о заказах
@allure.feature('Опеновские тесты')
@allure.story('Страница Уведомления в Open. Проверка оповещения при создании заказа из корзины Open')
@pytest.mark.parametrize('article', ['003L0145R 10'])
@pytest.mark.stage
@pytest.mark.xdist_group(name="open")
def test_41783_checking_alert_when_creating_an_order_from_open_cart(browser, article):
    """Страница Уведомления в Open. Проверка оповещения при создании заказа из корзины Open"""
    num_order = creation_kp(browser, article)

    page = Header(browser, link_open)
    page.go_to_notifications()

    page = NotificationsPage(browser, link_open)
    page.choice_check_box_orders()
    page.go_to_notification_by_order_number(num_order)

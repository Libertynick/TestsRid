import allure
import pytest

from config import TestEnvironment
from open_pages.header.header_page import Header
from open_pages.header.profile_menu_user import ProfileMenuUser
from open_pages.main_page.main_page import MainPage, AuthorizationModal
from open_pages.registration_page.registration_page import RegistrationPage
from open_pages.company_block.structure_company.company_blick import CompanyBlock, \
    QueueForConfirmationToCompany, ActiveUsersPage


@allure.feature('Опеновские тесты')
@allure.story('27222 и 27223 Регистрация нового пользователя физического лица')
@pytest.mark.xfail(reason='Не работает капча')
@pytest.mark.stage
def test_27222_and_27223_new_user_registration_individual(browser):
    """27222 и 27223 Регистрация нового пользователя физического лица"""
    date_of_birth = '01.05.1990'
    region = 'Москва'
    value_in_select_region = '41'  # Значение в select региона Москва
    type_of_work = 'Проектировщик'
    value_type_of_work = 'architect'  # value в селекте типа работы

    page = Header(browser, TestEnvironment.LINK_OPEN_TST)
    page.open()
    page.click_button_to_come_in()

    page = AuthorizationModal(browser, TestEnvironment.LINK_OPEN_TST)
    page.click_btn_registration()

    page = RegistrationPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.should_be_header_personal_data()
    page.entering_user_name()
    page.entering_surname()
    page.entering_user_patronymic()
    page.entering_date_of_birth(date_of_birth)

    page.click_on_next_button_in_first_registration_step()
    page.region_selection(region)
    page.choosing_type_of_work(type_of_work)
    page.checking_access_in_designer_work_type()
    page.click_on_next_button_in_second_registration_step()

    email_address = page.generation_mail_address()
    page.entering_email_address(email_address)
    phone_num = page.generation_phone()
    page.entering_phone_num(phone_num)
    page.entering_password()
    page.entering_repeat_password()
    page.confirmation_of_consent()

    # Получение куки сессии
    all_cookies = page.get_cookie_session()

    captcha_answer = page.captcha_solution_in_tst(all_cookies)
    answer = str(captcha_answer[0])

    page.entering_answer_captcha(answer)

    browser.delete_all_cookies()
    cookie_captcha = captcha_answer[1]

    # Добавление куки, полученные из капчи
    for key, value in cookie_captcha.items():
        browser.add_cookie({'name': key, 'value': value, 'domain': '.ruecom-open-tst1.ridancorp.net'})

    page.click_button_register()
    page.click_btn_go_to_community()


@pytest.mark.xfail(reason='Не работает капча')
@pytest.mark.stage
def test_27222_and_27223_new_user_registration_entity(browser):
    """27222 и 27223 Регистрация нового пользователя юридического лица"""
    date_of_birth = '01.05.1990'
    region = 'Москва'
    value_in_select_region = '41'  # Значение в select региона Москва
    inn_organization = TestEnvironment.INN_ORGANIZATION_UNIVED
    type_of_work = 'Дистрибьютор'
    value_type_of_work = '4'  # value в селекте типа работы

    page = Header(browser, TestEnvironment.LINK_OPEN_TST)
    page.open()
    page.click_button_to_come_in()

    page = AuthorizationModal(browser, TestEnvironment.LINK_OPEN_TST)
    page.click_btn_registration()

    page = RegistrationPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.should_be_header_personal_data()
    page.entering_user_name()
    page.entering_surname()
    page.entering_user_patronymic()
    page.entering_date_of_birth(date_of_birth)
    page.choice_checkbox_i_am_an_employee_of_a_legal_entity()
    page.entering_inn_of_organization(inn_organization)
    page.company_name_from_tin_field_must_match_name_in_company_field()
    page.click_on_next_button_in_first_registration_step()

    page.region_selection(region)
    page.choosing_type_of_work(type_of_work)
    page.checking_access_in_distributor_work_type()
    page.click_on_next_button_in_second_registration_step()

    email_address = page.generation_mail_address()
    page.entering_email_address(email_address)
    phone_num = page.generation_phone()
    page.entering_phone_num(phone_num)
    page.entering_password()
    page.entering_repeat_password()
    page.confirmation_of_consent()

    # Получение куки сессии
    all_cookies = page.get_cookie_session()

    captcha_answer = page.captcha_solution_in_tst(all_cookies)
    answer = str(captcha_answer[0])

    page.entering_answer_captcha(answer)

    browser.delete_all_cookies()
    cookie_captcha = captcha_answer[1]

    # Добавление куки, полученные из капчи
    for key, value in cookie_captcha.items():
        browser.add_cookie({'name': key, 'value': value, 'domain': '.ruecom-open-tst1.ridancorp.net'})

    page.click_button_register()
    page.click_btn_stay_in_open()

    # Переход в Профиль
    page = MainPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.authorization_from_main_page(TestEnvironment.LOGIN_TST_ELITA, TestEnvironment.PASSWORD_TST_ELITA)

    page = ProfileMenuUser(browser, TestEnvironment.LINK_OPEN_TST)
    page.go_to_queue_for_confirmation_to_company()

    page = QueueForConfirmationToCompany(browser, TestEnvironment.LINK_OPEN_TST)
    print(email_address)
    page.should_be_lin_on_e_mail(email_address)
    page.click_on_button_to_approve_by_e_mail(email_address)
    page.go_to_active_users_page()

    page = ActiveUsersPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.checking_display_of_a_record_from_e_mail(email_address)

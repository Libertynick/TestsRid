from pathlib import Path

import allure
import pytest
from base_page.base_page import BasePage
from config import TestEnvironment
from open_pages.header.profile_menu_user import ProfileMenuUser
from open_pages.main_page.main_page import MainPage
from open_pages.objects_page.fastening_requests.fastening_requests import FasteningRequestsPage, \
    CreatingRequestForFasteningPage, ModalNumberOfYourApplication


@allure.feature('Опеновские тесты')
@allure.story('25997. Объекты - Создание Заявки на крепление')
@pytest.mark.stage
def test_25997_fastening_request(browser):
    """Объекты - Создание Заявки на крепление"""

    link_open_tst = TestEnvironment.LINK_OPEN_TST
    login_open_tst = TestEnvironment.LOGIN_TST_VODOKOMFORT
    password_open_tst = TestEnvironment.PASSWORD_TST_VODOKOMFORT

    engineering_section = 'Тепловой Пункт/Котельная'  # Инженерный раздел для выбора при создании заявки
    access_to_object_manager = 'Есть'  # Доступ менеджеру объекта

    path_to_file_specification = str(
        Path.cwd() / "files_to_upload_to_page/Для_CleverDesk - 2 (ТП).pdf"
    )  # Путь к файлу для прикрепления спецификации на страницу

    inn_company_investor_customer = '7707083893'  # ИНН компании инвестора/заказчика
    contact_person_investor_customer = BasePage.generation_name_surname_patronymic()  # Контактное лицо в разделе Инвестор/Заказчик
    mail_address_investor_customer = BasePage.generation_mail_address()  # mail address в разделе Инвестор/Заказчик
    inn_company_general_contractor = '9500002813'  # ИНН компании Генеральный подрядчик
    contact_person_general_contractor = BasePage.generation_name_surname_patronymic()  # Контактное лицо в разделе Генеральный подрядчик
    mail_address_general_contractor = BasePage.generation_mail_address()  # mail address в разделе Генеральный подрядчик
    num_object = "1183570"

    page_main = MainPage(browser, link_open_tst)
    page_profile_menu_user = ProfileMenuUser(browser, link_open_tst)
    page_fastening_request = FasteningRequestsPage(browser, link_open_tst)
    page_creating_request_for_fastening = CreatingRequestForFasteningPage(browser, link_open_tst)
    page_modal_number_of_your_application = ModalNumberOfYourApplication(browser, link_open_tst)

    # Авторизация
    page_main.open()
    page_main.authorization_from_main_page(login_open_tst, password_open_tst)

    # Переход в Заявки на крепление
    page_profile_menu_user.go_to_applications_for_fastening()

    # Создание новой заявки
    page_fastening_request.button_new_requests()

    page_creating_request_for_fastening.checkbox_enter_name_yourself_must_not_be_selected()
    page_creating_request_for_fastening.input_name_object(num_object)
    page_creating_request_for_fastening.select_first_object_in_object_name_field()
    page_creating_request_for_fastening.checking_selected_sales_office()
    page_creating_request_for_fastening.check_selected_market()
    page_creating_request_for_fastening.check_values_in_market_drop_down_list()
    page_creating_request_for_fastening.check_selected_market()
    page_creating_request_for_fastening.check_object_address_field_is_not_editable()
    page_creating_request_for_fastening.check_object_address_not_empty()
    page_creating_request_for_fastening.selecting_an_engineering_section(engineering_section)
    page_creating_request_for_fastening.expand_drop_down_list_access_to_object_manager()
    page_creating_request_for_fastening.checking_contents_of_drop_down_list_access_to_object_manager()
    page_creating_request_for_fastening.select_value_from_drop_down_list_access_to_object_manager(
        access_to_object_manager)
    page_creating_request_for_fastening.attaching_specification(path_to_file_specification)

    # Раздел Инвестор/Заказчик
    page_creating_request_for_fastening.click_investor_customer_section_btn()
    page_creating_request_for_fastening.enter_name_or_inn_in_investor_customer_section(inn_company_investor_customer)
    page_creating_request_for_fastening.enter_contact_person_in_section_investor_customer(
        contact_person_investor_customer)
    page_creating_request_for_fastening.enter_mail_address_in_section_investor_customer(mail_address_investor_customer)

    # Раздел Генеральный подрядчик
    page_creating_request_for_fastening.open_section_general_contractor()
    page_creating_request_for_fastening.enter_name_or_inn_in_general_contractor_section(inn_company_general_contractor)
    page_creating_request_for_fastening.enter_contact_person_in_section_general_contractor(
        contact_person_general_contractor)
    page_creating_request_for_fastening.enter_mail_address_in_section_general_contractor(
        mail_address_general_contractor)
    page_creating_request_for_fastening.activate_toggle_switch_is_buyer_general_contractor()

    page_creating_request_for_fastening.click_btn_send()

    # Модалка Номер вашей заявки
    num_application = page_modal_number_of_your_application.save_num_application()
    print(num_application)
    page_modal_number_of_your_application.click_btn_return_to_application_list()

    # Страница Заявки на крепление
    page_fastening_request.click_advanced_search()
    page_fastening_request.search_fastening_requests(num_application)

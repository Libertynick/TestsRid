import allure
import pytest

from config import TestEnvironment
from open_pages.header.profile_menu_user import ProfileMenuUser
from open_pages.main_page.main_page import MainPage
from open_pages.order_details_page.order_details_page import OrderDetails, ModalWindowCancelOrder
from open_pages.order_list_page.order_list_page import OrderList


@allure.feature('Опеновские тесты')
@allure.story('Отмена заказа')
@pytest.mark.prod
def test_cancel_order_on_tst(browser):
    """Отмена заказа"""
    url_tst = TestEnvironment.LINK_OPEN_TST
    login_tst_vodokomfort = TestEnvironment.LOGIN_TST_VODOKOMFORT
    password_tst_vodokomfort = TestEnvironment.PASSWORD_TST_VODOKOMFORT

    page = MainPage(browser, url_tst)
    page.open()
    page.authorization_from_main_page(login_tst_vodokomfort, password_tst_vodokomfort)

    # Переход на страницу заказы
    page = ProfileMenuUser(browser, url_tst)
    page.go_to_orders_menu_distributor()
    page = OrderList(browser, url_tst)
    last_order = page.copy_last_order()
    page.order_search_by_number_and_author(last_order)
    page.go_to_order(last_order)

    # Детали заказа
    page = OrderDetails(browser, url_tst)
    page.click_order_cancellation()

    # Модалка Отмена заказа
    page = ModalWindowCancelOrder(browser, url_tst)
    page.should_be_title_cancel_order()
    page.click_send_request_in_modal_cancel_order()
    page.there_should_be_a_message_about_the_need_to_choose_a_reason()
    page.choice_of_reason_placement_error()
    page.entering_a_comment()
    page.click_send_request_in_modal_cancel_order()
    page.status_must_be_registered_in_json()

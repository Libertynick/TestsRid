import re
import time
from datetime import datetime

from open_pages.cart_page.cart_page import CartPage
from config import ProdEnvironment
from base_page.base_page_locators import BaseOpenLocators
import pytest


@pytest.mark.monitoring
def keeping_products_in_the_shopping_cart(browser):
    """Сохранение наличия продукции в корзине"""
    count_articles_for_basket = 20  # Количество артикулов для добавления в корзину
    quantity_code_for_basket = '9999'  # Количество кодов для добавления в корзину

    name_file = 'results/result_test_keeping_products_in_the_shopping_cart/' + str(
        datetime.now().strftime("%Y_%d_%b_%H_%M_%S_GMT")) + '.csv'
    with open(name_file, 'a') as file:
        file.write('Код исходного материала;Код материала из корзины;Кол-во доступное на складе;Кол-во в поставке;'
                   'Дата поставки;Кол-во под заказ;Комментарий\n')

    with open("tests/keeping_products_in_the_shopping_cart/codes_for_test", "r") as file:
        codes_for_test_list = [line.strip().upper() for line in file if not line.isspace()]

    link = ProdEnvironment.LINK_CART_OPEN_PROD
    page = CartPage(browser, link)
    page.open()

    print(len(codes_for_test_list))
    for code in range(0, len(codes_for_test_list), count_articles_for_basket):
        codes_list_for_basket = codes_for_test_list[code:code + count_articles_for_basket]
        codes_list_for_basket = [el + f' {quantity_code_for_basket} ' for el in codes_list_for_basket]

        print(codes_list_for_basket)
        # page.open()
        time.sleep(2)
        page.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT, sec=90)
        page.type_product_in_input(codes_list_for_basket)
        page.click_add_button()

        text_modal_info = page.save_text_from_info_modal_and_close()
        text_modal_info = re.sub(r'[;,.]', '', text_modal_info)

        quantity_in_stock = 0  # Количество на складе
        quantity_supply = 0  # Количество на поставку
        date_supply = ''  # Дата поставки
        quantity_on_order = 0  # Количество под заказ

        if len(text_modal_info) > 0:
            for line_code in codes_list_for_basket:
                article = line_code.split(' ')[0]
                with open(name_file, 'a') as file:
                    file.write(
                        f'{article + ","};'
                        f'{quantity_in_stock};'
                        f'{quantity_supply};{date_supply};{quantity_on_order};{text_modal_info}\n')
        else:
            for line_code in codes_list_for_basket:
                article = line_code.split(' ')[0]
                print()
                print(article)
                availability_for_sale = page.checking_the_blocking_of_material_for_sales(
                    article)  # Доступность для продажи
                print(f'Доступность для продажи {availability_for_sale}')
                autocorrect_code = page.check_if_there_is_code_autocorrect(article)  # Автозамена кода
                print(autocorrect_code, 'Автозамена')
                if len(autocorrect_code) != 0:
                    article = autocorrect_code[1]

                quantity_in_stock = page.store_quantity_in_stock(article)  # Количество на складе
                print(f'Количество на складе {quantity_in_stock}')
                quantity_and_date_supply = page.saving_quantity_and_delivery_date(article)  # Количество и дата поставки
                quantity_supply = quantity_and_date_supply[0]  # Количество на поставку
                date_supply = quantity_and_date_supply[1]  # Дата поставки
                print(f'Количество и дата поставки {quantity_supply} {date_supply}')

                quantity_on_order = page.keeping_the_quantity_on_order(article)  # Количество под заказ

                print(
                    f'{autocorrect_code[0] + "," + autocorrect_code[1] if len(autocorrect_code) != 0 else article + "," + ""},'
                    f'{quantity_in_stock},'
                    f'{quantity_supply},{date_supply},{quantity_on_order},{availability_for_sale}')
                with open(name_file, 'a') as file:
                    file.write(
                        f'{autocorrect_code[0] + ";" + autocorrect_code[1] if len(autocorrect_code) != 0 else article + ";" + ""};'
                        f'{quantity_in_stock};'
                        f'{quantity_supply};{date_supply};{quantity_on_order};{availability_for_sale}\n')
        page.click_empty_trash()

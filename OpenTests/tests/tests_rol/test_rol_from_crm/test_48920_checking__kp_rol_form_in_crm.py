import allure
import pytest

from base_page.base_page import BasePageCrm
from config import TestEnvironment
from crm_pages.organization_page.editing_organization_page import EditingOrganization
from crm_pages.modal_new_kp.modal_new_kp import ModalNewKpRol


@allure.feature('ROL CRM')
@allure.story('Проверка формы создания КП')
@pytest.mark.stage
def test_48920_checking_kp_rol_form_in_crm(browser, auth_crm_extru_start):
    """Проверка формы КП РОЛ в CRM
    тест- кейс - https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/48920
    """
    login_crm = TestEnvironment.LOGIN_CRM
    organization_url = TestEnvironment.ORGANIZATION_VODOKOMFORT_TST

    expected_potential_mode = 'Полная закупка'  # Ожидаемый режим потенциала
    expected_end_customer = 'ООО ФИРМА "ВОДОКОМФОРТ"'  # Ожидаемый конечный клиент
    expected_validity_period = '14 дней'  # Ожидаемый срок действия
    expected_head_transportation_costs = 'Транспортные расходы:'  # Ожидаемый заголовок Транспортные расходы в разделе Дополнительные расходы
    expected_head_shipment_from_warehouse_in_moscow = 'Отгрузка со склада в г.Москва:'  # Ожидаемый заголовок Отгрузка
    # со склада в г.Москва: в разделе Дополнительные расходы

    expected_head_shipment_from_warehouse_in_dzerzhinsk = 'Отгрузка со склада в г.Дзержинск:'  # Заголовок Отгрузка со склада в г. Дзержинск:
    expected_header_type_of_delivery = 'Вид доставки'  # Ожидаемый заголовок Вид доставки
    expected_header_payment_mode = 'Режим оплаты'  # Ожидаемый заголовок Режим оплаты
    expected_delivery_method = 'Доставка до терминала'  # Ожидаемый вид доставки
    expected_list_name_link_in_details_pq_tab = ['Детали']  # Ожидаемый список ссылок в разделе Детали КП

    page = BasePageCrm(browser, organization_url)
    auth_crm_extru_start(ruco=login_crm)
    page.open()

    page = EditingOrganization(browser, organization_url)

    page.click_btn_kp_rol()

    page = ModalNewKpRol(browser, organization_url)
    page.check_header_in_modal()
    page.check_date_in_deal_section()
    page.check_in_filling_kp_selected_components_and_to()
    page.checking_that_btp_is_not_displayed_in_filling_of_kp()
    page.check_potential_mode(expected_potential_mode)
    page.check_that_distributor_field_is_empty()
    page.check_of_selected_end_customer(expected_end_customer)
    page.check_that_contract_number_field_is_empty()
    page.checking_that_contract_number_field_is_not_clickable()
    page.check_expiration_value(expected_validity_period)
    page.check_that_expiration_date_field_is_not_clickable()
    page.check_that_full_name_client_field_is_not_empty()
    page.check_that_details_client_field_is_not_empty()
    page.internal_course_toggle_switch_must_be_turned_on()
    page.checking_that_internal_rate_switch_is_not_clickable()
    page.check_inn_checked()
    page.check_heading_in_additional_expenses(expected_head_transportation_costs)
    page.checking_input_field_transportation_costs_in_rub_is_blocked()
    page.check_amount_of_transport_costs_in_rubles()
    page.check_heading_in_additional_expenses(expected_head_shipment_from_warehouse_in_moscow)
    page.checking_that_field_shipment_from_warehouse_in_moscow_is_empty()
    page.checking_input_field_shipment_from_warehouse_in_moscow_is_blocked()
    page.check_heading_in_additional_expenses(expected_head_shipment_from_warehouse_in_dzerzhinsk)
    page.checking_input_shipment_from_warehouse_in_dzerzhinsk_is_blocked()
    page.check_invisibility_input_transportation_costs_cu()
    page.check_invisibility_input_weight_shipment_from_warehouse_in_moscow()
    page.check_invisibility_input_shipment_from_warehouse_in_dzerzhinsk()
    page.check_head_delivery_conditions()
    page.checking_that_delivery_to_specified_address_is_selected()
    page.check_that_drop_down_list_is_for_delivery_to_specified_address()
    page.check_address_header()
    page.check_entered_address()
    page.check_heading_in_additional_expenses(expected_header_type_of_delivery)
    page.checking_selected_delivery_method(expected_delivery_method)
    page.check_heading_in_additional_expenses(expected_header_payment_mode)
    page.check_the_delivery_paid()
    page.check_that_payment_mode_field_is_not_editable()
    page.hide_block_payment_terms()
    page.disclosure_of_payment_terms_block()
    page.there_must_be_an_advance_payment()
    page.check_that_payment_terms_field_is_not_editable()
    page.check_that_add_zip_button_is_blocked()
    page.check_btn_add_position_to_kp_is_blocked()
    page.check_placeholder_text_in_code_entry_field()

    name_link_in_details_kp_tab = page.save_name_link_in_pq_details_tab()
    with allure.step('Проверка ссылок в разделе Детали КП'):
        assert expected_list_name_link_in_details_pq_tab == name_link_in_details_kp_tab, \
            f'Ссылки в разделе Детали КП - ({name_link_in_details_kp_tab}) не соответствуют ожидаемым - ' \
            f'({expected_list_name_link_in_details_pq_tab})'

    page.check_that_block_files_and_comments_is_opened()
    page.check_field_comments_is_invisible()
    page.check_that_show_discount_column_switch_is_on()
    page.check_that_show_discount_column_switch_is_blocked()
    page.checking_title_in_file_upload_section()
    page.checking_number_of_downloaded_files()
    page.checking_that_in_file_uploads_there_is_only_one_add_button()

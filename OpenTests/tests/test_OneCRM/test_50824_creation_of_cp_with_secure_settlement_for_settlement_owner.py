import allure
import pytest

from api_testing_project.services.crm_commerce.create_offer.api.api_create_offer import ApiCreateOffer
from api_testing_project.services.order.api.api_order_simulate import ApiOrderSimulate
from api_testing_project.services.order.api.api_order_update_offer import ApiOrderUpdateOffer
from config import TestEnvironment
from crm_pages.pq_page.pq_page import PqPage
from crm_pages.search_pq_page.search_pq_page import SearchPq


@allure.feature('CRM')
@allure.story('Появление согласования маржи после обновления себестоимости')
@pytest.mark.stage
@pytest.mark.parametrize('article', ['w204010133'])
def test_50824_creation_of_cp_with_secure_settlement_for_settlement_owner(browser, article, auth_crm_extru_start):
    """Создание КП с защищенным расчетом - для владельца расчета"""
    link_search_pq_in_crm = TestEnvironment.LINK_SEARCH_PQ_TST
    page_search_pq_in_crm = SearchPq(browser, link_search_pq_in_crm)
    page_pq_in_crm = PqPage(browser, link_search_pq_in_crm)

    user_crm = 'RUCO2249'  # Семенов Илья

    false = False
    true = True
    null = None
    headers_create_offer_and_update_offer = {"userId": "d7527adc-a037-4649-928f-8ab38622e948"}  # userId - Семенов Илья

    request_simulate = {
        "debtorAccount": "35389_01",
        "materials": [
            {
                "materialCode": "w204010133",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "useSpecialPrice": true
            }
        ],
        "paymentTerms": "RU00",
        "personId": "e9a28e72-d980-4e88-967f-f1950c7deec6",
        "offerId": null,
        "currency": "RUB",
        "currencyDate": "2025-04-03T00:00:00",
        "exchangeRateType": "YRU",
        "returnAutoPrice": false,
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "specificationId": "a724b41a-841c-45e3-bce9-ed1810b2a8d1",
        "returnKitDisconts": true,
        "returnVolumeDisconts": true,
        "returnAdditionalBTP": false
    }  # Запрос на API Order/Simulate
    request_create_offer = {
        "docType": "Order",
        "showPriceWithDiscount": true,
        "showDiscount": false,
        "currencyDate": "2025-04-03T00:00:00",
        "currency": "RUB",
        "exchangeRateType": "YRU",
        "userName": "RIDANCORP\\RUCO2249",
        "personId": "00cf55d0-2613-4400-beb1-57eb2a17a9ca",
        "usePromoCurrency": true,
        "passportId": "E75FC108-8746-44DD-9865-034113106931",
        "specTypeId": "02061701-51E6-402E-B18F-7BAE7A27F6FB",
        "specificationId": "A724B41A-841C-45E3-BCE9-ED1810B2A8D1",
        "paymentTerms": "RU00",
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "payPercentBeforePlacingIntoProduction": 100,
        "isDraft": true,
        "isEndUserPQ": false,
        "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
        "finalBuyerId": "acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9",
        "customerId": "d9f129e3-c2b4-4ee7-a018-1ef60c97e563",
        "clientInn": "7707762609",
        "debtorAccount": "35389_01",
        "currencySpecialFixation": true,
        "setContractDiscounts": true,
        "orderLines": [
            {
                "ODID": null,
                "materialCode": "w204010133",
                "RequestedMaterialCode": "w204010133",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "discountPercent": 0,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "HEX",
                "copiedFromId": null
            }
        ],
        "deliveryOptions": null,
        "deliveryOptionsHex": null,
        "deliveryOptionsProd": null,
        "deliveryOptionsDZRProd": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "Address": "",
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "7705238125"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 1922.34,
            "endPoint": "ToTK",
            "deliveryType": "PickupDZR",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "isExport": false,
        "validDays": 14,
        "source": null,
        "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
        "IsATOffer": false,
        "autoFromEngSpec": false,
        "isNew": true
    }
    request_update_offer = {
        "docType": "Order",
        "showPriceWithDiscount": true,
        "showDiscount": false,
        "currencyDate": "2025-04-03T00:00:00",
        "currency": "RUB",
        "exchangeRateType": "YRU",
        "userName": "RIDANCORP\\RUCO2249",
        "personId": "00cf55d0-2613-4400-beb1-57eb2a17a9ca",
        "usePromoCurrency": true,
        "offerId": "2b6af8a9-c319-4b37-7c0f-08dd728e8406",
        "passportId": "E75FC108-8746-44DD-9865-034113106931",
        "specTypeId": "02061701-51E6-402E-B18F-7BAE7A27F6FB",
        "specificationId": "A724B41A-841C-45E3-BCE9-ED1810B2A8D1",
        "paymentTerms": "RU00",
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "payPercentComponentsBTP": null,
        "payPercentBeforePlacingIntoProduction": 100,
        "isDraft": false,
        "isEndUserPQ": false,
        "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
        "finalBuyerId": "ACB8F425-C3B6-4B38-9F34-1E7FBFD53FA9",
        "customerId": "D9F129E3-C2B4-4EE7-A018-1EF60C97E563",
        "clientInn": "7707762609",
        "availableForDistributor": false,
        "autoAvailableForDistributor": true,
        "debtorAccount": "35389_01",
        "currencySpecialFixation": true,
        "setContractDiscounts": true,
        "orderLines": [
            {
                "ODID": "3616ff07-060e-4739-8dff-e0f8bbdce4e7",
                "materialCode": "w204010133",
                "RequestedMaterialCode": "w204010133",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "discountPercent": 0,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "HEX",
                "copiedFromId": null
            }
        ],
        "deliveryOptions": null,
        "deliveryOptionsHex": null,
        "deliveryOptionsProd": null,
        "deliveryOptionsDZRProd": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "Comment": null,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "DestinationFiasId": null,
                "Address": null,
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "7705238125"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 1922.34,
            "endPoint": "ToTK",
            "deliveryType": "PickupDZR",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "isExport": false,
        "validDays": 14,
        "source": null,
        "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
        "IsATOffer": false,
        "autoFromEngSpec": false,
        "isNew": false
    }

    api_simulate = ApiOrderSimulate()
    api_create_offer = ApiCreateOffer()
    api_update_offer = ApiOrderUpdateOffer()

    # Запрос на API Order/Simulate. Проверяем, что добавленный расчет защищенный
    expected_description = 'Защищённый расчёт ПТО'

    api_simulate.post_order_simulate(request_simulate)
    api_simulate.check_field_description_in_statuses_order_lines(expected_description)

    # Создание КП в статусе Черновик через Дапи
    id_offers, num_pq = api_create_offer.create_offer(
        headers=headers_create_offer_and_update_offer, request=request_create_offer)

    # Отправляем на согласование созданное КП через Дапи
    request_update_offer["offerId"] = id_offers
    api_update_offer.post_update_offer(data=request_update_offer, headers=headers_create_offer_and_update_offer)

    auth_crm_extru_start(ruco=user_crm)
    page_search_pq_in_crm.open()

    page_search_pq_in_crm.search_pq(num_pq)
    page_search_pq_in_crm.go_to_pq_by_number_in_new_tab(num_pq)
    page_pq_in_crm.check_calculation_does_not_have_flag_pending_ik_approval(article, num_pq)
    page_pq_in_crm.create_account()
    page_pq_in_crm.waiting_for_account_creation()

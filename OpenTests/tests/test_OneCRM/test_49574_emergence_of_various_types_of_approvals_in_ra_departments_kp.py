import allure

from api_testing_project.services.crm_commerce.create_offer.api.api_create_offer import ApiCreateOffer
from config import TestEnvironment
from crm_pages.pq_page.pq_page import PqPage


@allure.feature('CRM')
@allure.story('Возникновение согласований разного типа в КП отдела RA')
def test_49574_emergence_of_various_types_of_approvals_in_ra_departments_kp(browser, auth_crm_extru_start):
    """
    Возникновение согласований разного типа в КП отдела RA
    https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/49574
    """
    link_pq = TestEnvironment.LINK_PQ_IN_CRM
    user_ruco = 'RUCO2284'  # Туманов Роман

    null = None
    true = True
    false = False

    req_create_offer = {
        "docType": "Order",
        "showPriceWithDiscount": false,
        "showDiscount": true,
        "currencyDate": "2025-05-23T00:00:00",
        "currency": "RUB",
        "exchangeRateType": "YRU",
        "userName": "RUCO2284",
        "personId": "9f65273c-7f31-4817-8488-8be76cfe6112",
        "usePromoCurrency": true,
        "passportId": "4DBB2A44-D895-468D-A51F-AE98B9B3D487",
        "specTypeId": "E4729244-7A88-4128-BB31-A53A49405405",
        "specificationId": "98C9C9C4-2A05-4592-BCAC-635B88D0ECD6",
        "paymentTerms": "RU00",
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "payPercentBeforePlacingIntoProduction": 100,
        "isDraft": true,
        "isEndUserPQ": false,
        "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
        "finalBuyerId": "a7a31382-e984-44b1-8ec6-bde558266041",
        "customerId": "aa890eff-7aa9-46c3-a887-29220f5a4274",
        "clientInn": "9705031050",
        "debtorAccount": "RT25-9705031050-HE",
        "currencySpecialFixation": true,
        "setContractDiscounts": true,
        "orderLines": [
            {
                "ODID": null,
                "materialCode": "w488900",
                "RequestedMaterialCode": "w488900",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "HEX",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "009L7020R",
                "RequestedMaterialCode": "009L7020R",
                "quantity": 1,
                "lineNumber": 2,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "021B8730R",
                "RequestedMaterialCode": "021B8730R",
                "quantity": 1,
                "lineNumber": 3,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "027H3001",
                "RequestedMaterialCode": "027H3001",
                "quantity": 1,
                "lineNumber": 4,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            }
        ],
        "deliveryOptions": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "Address": "",
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "7107018050"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 10.943000000000001,
            "endPoint": "ToTK",
            "deliveryType": "Pickup",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "deliveryOptionsHex": null,
        "deliveryOptionsProd": null,
        "deliveryOptionsDZRProd": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "Address": "",
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "7107018050"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 193.12,
            "endPoint": "ToTK",
            "deliveryType": "PickupDZR",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "isExport": false,
        "validDays": 14,
        "source": null,
        "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
        "IsATOffer": false,
        "autoFromEngSpec": false,
        "isNew": true
    }  # Запрос на создание КП через createOffer
    headers = {'userId': '76a95868-e507-4083-8fba-9b29b9a7831c'}  # userId  Туманов Роман

    type_of_agreement_visible_after_save = [
        'Незакрепленное КП',
        'Маржа RA ГЦМ',
        'Скидки RA',
        'Маржа',
        'Согласование HEX',
        'Согласование RA (HE)',
        'Согласование RA ГЦМ'
    ]  # Типы согласований после сохранения
    type_of_agreement_visible_after_save_after_change_condition = [
        'Незакрепленное КП',
        'Маржа RA ГЦМ',
        'Скидки RA',
        'Маржа',
        'Согласование HEX',
        'Согласование RA (HE)',
        'Согласование RA ГЦМ',
        'Предоплата',
        'Кредитный контроль',
        'Фиксированный курс'
    ]  # Типы согласований после изменений условий в КП
    expected_status_agreement = {
        'Незакрепленное КП': 'в процессе',
        'Маржа RA ГЦМ': 'в процессе',
        'Скидки RA': 'в процессе',
        'Маржа': 'в процессе',
        'Согласование HEX': 'в процессе',
        'Согласование RA (HE)': 'в процессе',
        'Согласование RA ГЦМ': 'в процессе',
        'Предоплата': 'в процессе',
        'Кредитный контроль': 'в процессе',
        'Фиксированный курс': 'в процессе'
    }  # Ожидаемые статусы у согласований
    delivery_type = 'Доставка на указанный адрес'

    # Создаем КП через Дапи
    api_create_offer = ApiCreateOffer()
    id_pq, num_pq = api_create_offer.create_offer(headers=headers, request=req_create_offer)
    print(id_pq, num_pq)

    link_pq_total = link_pq + id_pq
    page_pq = PqPage(browser, link_pq_total)

    auth_crm_extru_start(ruco=user_ruco)
    # Открываем КП в срм
    page_pq.open()
    page_pq.click_btn_save_pq()
    page_pq.check_visible_type_of_agreement(type_of_agreement_visible_after_save, num_pq)
    page_pq.switching_currency_to_a_fixed_rate()
    page_pq.selection_of_delivery_conditions(delivery_type)
    page_pq.check_the_delivery_paid()
    page_pq.expanding_payment_terms_menu()
    page_pq.click_on_button_agree_on_payment_terms()
    page_pq.click_btn_save_pq()
    page_pq.check_visible_type_of_agreement(type_of_agreement_visible_after_save_after_change_condition, num_pq)
    page_pq.send_for_approval_pq_page()
    page_pq.status_of_checkpoint_must_be_approval()
    for key, value in expected_status_agreement.items():
        page_pq.checking_approval_status(type_agreement=key, expected_status_agreement=value)

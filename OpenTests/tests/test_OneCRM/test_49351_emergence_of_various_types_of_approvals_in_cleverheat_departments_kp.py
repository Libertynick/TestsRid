import allure

from api_testing_project.services.crm_commerce.create_offer.api.api_create_offer import ApiCreateOffer
from config import TestEnvironment
from crm_pages.pq_page.pq_page import PqPage

true = True
false = False
null = None

headers = {'userId': '770b060c-4a2f-4638-adbb-dfbeb1813754'}  # userId Баженов Дмитрий
req_create_offer = {
    "docType": "Order",
    "showPriceWithDiscount": true,
    "showDiscount": false,
    "currencyDate": "2025-05-22T00:00:00",
    "currency": "RUB",
    "exchangeRateType": "YRU",
    "userName": "RUCO9898 ",
    "personId": "f8eaae4a-1309-4b24-95e8-3a092dc30067",
    "usePromoCurrency": true,
    "passportId": "C63A537E-189D-4B81-BE2F-EB314B45D87B",
    "specTypeId": "02061701-51E6-402E-B18F-7BAE7A27F6FB",
    "specificationId": "EDD4FCE5-774B-4E94-A24D-CCC4BB62DCE5",
    "paymentTerms": "RU00",
    "surchargesPayment": "0",
    "surchargesConversion": 0,
    "payPercentBeforePlacingIntoProduction": 100,
    "isDraft": true,
    "isEndUserPQ": false,
    "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
    "finalBuyerId": "4c03ae0b-424b-40d0-a54d-76ccfeddb785",
    "customerId": "aa890eff-7aa9-46c3-a887-29220f5a4274",
    "clientInn": "9705031050",
    "debtorAccount": "RT25-9705031050-HE",
    "currencySpecialFixation": true,
    "setContractDiscounts": true,
    "orderLines": [
        {
            "ODID": null,
            "materialCode": "w003013006",
            "RequestedMaterialCode": "w003013006",
            "quantity": 1,
            "lineNumber": 1,
            "usePromoCurrency": true,
            "discountPercent": 77,
            "endClientDiscountPercent": 0,
            "excludePosition": false,
            "useSpecialPrice": false,
            "lineType": "HEX",
            "copiedFromId": null
        },
        {
            "ODID": null,
            "materialCode": "w501321655",
            "RequestedMaterialCode": "w501321655",
            "quantity": 1,
            "lineNumber": 2,
            "usePromoCurrency": true,
            "discountPercent": 77,
            "endClientDiscountPercent": 0,
            "excludePosition": false,
            "useSpecialPrice": false,
            "lineType": "HEX",
            "copiedFromId": null
        }
    ],
    "deliveryOptions": null,
    "deliveryOptionsHex": null,
    "deliveryOptionsProd": null,
    "deliveryOptionsDZRProd": {
        "ConsigneeCode": null,
        "Condition": "RU",
        "DeliveryCost": 0,
        "ClientFinalDelivery": null,
        "ConsigneeContacts": null,
        "consigneeAgreementDelivery": {
            "SourceFiasId": "00000000-0000-0000-0000-000000000000",
            "Address": "",
            "PaidDelivery": false,
            "ConditionDescription": "Стандартные договорные условия",
            "INN": "3665105030"
        },
        "CostIncludedInOrder": false,
        "totalDeliveryWeight": 183.29999999999998,
        "endPoint": "ToTK",
        "deliveryType": "PickupDZR",
        "consigneeId": "00000000-0000-0000-0000-000000000000"
    },
    "isExport": false,
    "validDays": 14,
    "source": null,
    "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
    "IsATOffer": false,
    "autoFromEngSpec": false,
    "isNew": true
}

api_create_offer = ApiCreateOffer()


@allure.feature('CRM')
@allure.story('Возникновение согласований разного типа в КП отдела Cleverheat')
def test_49351_emergence_of_various_types_of_approvals_in_cleverheat_departments_kp(browser, auth_crm_extru_start):
    """
    https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/49351
    Возникновение согласований разного типа в КП отдела Cleverheat
    """
    link_pq = TestEnvironment.LINK_PQ_IN_CRM

    ruco_user = 'RUCO9898'  # Баженов Дмитрий
    type_kp = 'CLH'
    delivery_type = 'Доставка на указанный адрес'
    type_agreement_no_visible = ['Расчётный отдел', 'Закупки Ридан', 'Логистика Ридан']
    type_of_agreement_visible_after_save = [
        'Маржа Clever',
        'Согласование CleverHeat - согласовано автором КП'
    ]  # Типы согласований после сохранения
    type_of_agreement_visible_after_save_after_change_condition = [
        'Согласование CleverHeat', 'Кредитный контроль', 'Предоплата', 'Доставка', 'Маржа Clever'
    ]  # Типы согласований после изменений условий в КП
    expected_status_agreement = {
        'CleverHeat': 'согласовано',
        'Доставка': 'согласовано',
        'Маржа Clever': 'в процессе',
        'Предоплата': 'в процессе',
        'Кредитный контроль': 'в процессе'
    }  # Ожидаемые статусы у согласований

    id_pq, num_pq = api_create_offer.create_offer(headers=headers, request=req_create_offer)

    print(id_pq, num_pq)

    link_pq_total = link_pq + id_pq
    print(link_pq_total)

    page_pq = PqPage(browser, link_pq_total)

    auth_crm_extru_start(ruco=ruco_user)
    page_pq.open()
    page_pq.click_btn_save_pq()
    page_pq.check_name_pq(expected_name_pq=type_kp, num_pq=num_pq)
    page_pq.check_visible_type_of_agreement(type_of_agreement_visible_after_save, num_pq)
    for el in type_agreement_no_visible:
        page_pq.check_no_visible_type_of_agreement(el, num_pq)
    page_pq.switching_currency_to_a_fixed_rate()
    page_pq.selection_of_delivery_conditions(delivery_type)
    page_pq.choice_of_free_payment_mode()
    page_pq.expanding_payment_terms_menu()
    page_pq.click_on_button_agree_on_payment_terms()
    page_pq.click_btn_save_pq()
    page_pq.check_visible_type_of_agreement(type_of_agreement_visible_after_save_after_change_condition, num_pq)
    page_pq.send_for_approval_pq_page()
    page_pq.status_of_checkpoint_must_be_approval()

    for key, value in expected_status_agreement.items():
        page_pq.checking_approval_status(type_agreement=key, expected_status_agreement=value)

import allure
import pytest

from config import TestEnvironment
from conftest import auth_crm_extru_start
from crm_pages.modal_new_kp.modal_new_kp import ModalNewKp
from crm_pages.object_page.object_page import ObjectPage


@allure.feature('CRM')
@allure.story('Проверка правильности расчета суммы позиции в CRM')
@pytest.mark.stage
@pytest.mark.parametrize('article', ['065N0750GR 003L0125R 003L0144R'])
@pytest.mark.parametrize('chapter', [
    'ТП', 'ПЧ', 'КСО Н', 'КСО В', 'АТМ', 'Кот', 'Тех', 'ВиК', 'УРФ', 'ХЦК', 'ХМ', 'ТВУ', 'СО Ж'
])
def test_43646_checking_correctness_of_position_amount_calculation_in_crm(browser, article, chapter,
                                                                          auth_crm_extru_start):
    """Проверка правильности расчета суммы позиции в CRM"""
    list_article = article.split(' ')
    link_crm_tst = TestEnvironment.LINK_CRM_TST
    login_crm_tst = 'RUCO1681'  # ruco Оганесян Левон
    object_tst = TestEnvironment.LINK_OBJECT_IN_TST
    distributor_tst = TestEnvironment.DISTRIBUTOR_VODOKOMFORT_TST

    auth_crm_extru_start(ruco=login_crm_tst)

    page = ObjectPage(browser, object_tst)
    page.open()
    page.click_add_kp(chapter)

    page = ModalNewKp(browser, link_crm_tst)
    page.choice_distributor(distributor_tst)
    page.choice_sap_code_main_contract()
    page.choice_final_buyer()
    page.adding_codes(article)
    page.there_must_be_an_advance_payment()

    page.checking_calculation_of_total_amount_with_nds_by_items(list_article)

import allure

from api_testing_project.services.crm_commerce.create_offer.api.api_create_offer import ApiCreateOffer


@allure.feature('CRM')
@allure.story('Возникновение согласований разного типа в КП отдела Devi')
def test_49358_emergence_of_various_types_of_approvals_in_kp_of_devi_department(
        browser,
        auth_crm_extru_start,
        emergence_of_different_types_of_agreements_in_kp
):
    """
    Возникновение согласований разного типа в КП отдела Devi
    https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/49358
    """

    user_ruco = 'RUCO0984'  # Бардин Дмитрий

    type_of_agreement_visible_after_save = [
        'Скидки',
        'Маржа',
        'Согласование DEVI'
    ]  # Типы согласований после сохранения
    type_of_agreement_visible_after_save_after_change_condition = [
        'Скидки',
        'Маржа',
        'Согласование DEVI',
        'Доставка',
        'Предоплата',
        'Кредитный контроль',
        'Фиксированный курс'
    ]  # Типы согласований после изменений условий в КП

    expected_status_agreement = {
        'Доставка ': 'в процессе',
        'Маржа': 'в процессе',
        'Предоплата': 'в процессе',
        'Кредитный контроль': 'в процессе',
        'Фиксированный курс': 'в процессе',
        'Согласование DEVI': 'в процессе',
        'Скидки': 'в процессе'
    }  # Ожидаемые статусы у согласований

    delivery_type = 'Доставка на указанный адрес'

    null = None
    true = True
    false = False

    headers = {'userId': '1ca4a9eb-ee45-4d7d-8fb9-45cb7960ed79'}  # userId  Бардин Дмитрий
    req_create_offer = {
        "docType": "Order",
        "showPriceWithDiscount": false,
        "showDiscount": true,
        "currencyDate": "2025-05-26T00:00:00",
        "currency": "RUB",
        "exchangeRateType": "YRU",
        "userName": "RUCO0984",
        "personId": "ec3f885f-752e-406b-9d30-939c1f4ece8c",
        "usePromoCurrency": true,
        "passportId": "4DBB2A44-D895-468D-A51F-AE98B9B3D487",
        "specTypeId": "DEF30661-4605-4AB5-B6E5-B03831452047",
        "specificationId": "1B532E08-C1BA-4532-8D7D-EB23CC7E2DFE",
        "paymentTerms": "RU00",
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "payPercentBeforePlacingIntoProduction": 100,
        "isDraft": true,
        "isEndUserPQ": false,
        "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
        "finalBuyerId": "6e24bca8-9517-4c86-9a2a-074b3d069402",
        "customerId": "aa890eff-7aa9-46c3-a887-29220f5a4274",
        "clientInn": "9705031050",
        "debtorAccount": "RT25-9705031050-HE",
        "currencySpecialFixation": true,
        "setContractDiscounts": true,
        "orderLines": [
            {
                "ODID": null,
                "materialCode": "140F1246R",
                "RequestedMaterialCode": "140F1246R",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "19808236R",
                "RequestedMaterialCode": "19808236R",
                "quantity": 1,
                "lineNumber": 2,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "088H3142R",
                "RequestedMaterialCode": "088H3142R",
                "quantity": 1,
                "lineNumber": 3,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            }
        ],
        "deliveryOptions": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "Address": "",
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "9718070427"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 4.561000000000001,
            "endPoint": "ToTK",
            "deliveryType": "Pickup",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "deliveryOptionsHex": null,
        "deliveryOptionsProd": null,
        "deliveryOptionsDZRProd": null,
        "isExport": false,
        "validDays": 14,
        "source": null,
        "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
        "IsATOffer": false,
        "autoFromEngSpec": false,
        "isNew": true
    }

    # Создаем КП через Дапи
    api_create_offer = ApiCreateOffer()
    id_pq, num_pq = api_create_offer.create_offer(headers=headers, request=req_create_offer)
    print(id_pq, num_pq)

    auth_crm_extru_start(ruco=user_ruco)

    emergence_of_different_types_of_agreements_in_kp(
        id_pq=id_pq,
        num_pq=num_pq,
        type_of_agreement_visible_after_save=type_of_agreement_visible_after_save,
        type_of_agreement_visible_after_save_after_change_condition=type_of_agreement_visible_after_save_after_change_condition,
        delivery_type=delivery_type, expected_status_agreement=expected_status_agreement
    )

from datetime import datetime

from config import TestEnvironment
from crm_pages.organization_page.editing_organization_page import EditingOrganization, ModalEditPhone, ModalEditAddress
from crm_pages.organization_page.organization_page import OrganizationPage
from crm_pages.search_organization_page.search_organization_page import SearchOrganizationPage, ModalNewCounterparty


def test_50843_creation_and_editing_of_an_organization_card_by_an_employee_of_ic_department(
        browser, auth_crm_extru_start
):
    """
    Создание и редактирование карточки организации сотрудником отдела ИК
    https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/50843
    """
    link_search_organization = TestEnvironment.LINK_ORGANIZATION_SEARCH_CRM
    page_search_organization = SearchOrganizationPage(browser, link_search_organization)
    modal_new_counterparty = ModalNewCounterparty(browser, link_search_organization)
    page_organization = OrganizationPage(browser, link_search_organization)
    page_editing_organization = EditingOrganization(browser, link_search_organization)
    modal_edit_phone = ModalEditPhone(browser, link_search_organization)
    modal_edit_address = ModalEditAddress(browser, link_search_organization)

    ruco_user = 'RUCO1683'  # Анисимов Александр

    inn_name_address = 'Компания'  # Значение для ввода в поле "ИНН, название, адрес"
    form_company = 'Юр. лицо РФ'  # Форма компании
    responsible_manager = 'Осипов Андрей Игоревич'  # Ответственный менеджер
    player = 'ПП - Перепродавец'  # Игрок
    remark = 'тестирование создания и редактирования карточки организации. auto_test'
    direction = ['Другое']  # Направление
    segments_list = ['Перепродавец Теплоавтоматика РФ']
    phone_num = '(111) 222-33-44'

    now = datetime.now()
    formatted_date = now.strftime('%d%m%Y %H.%M.%S')
    inn_organization = formatted_date
    name_organization = f'Компания_{formatted_date}'

    auth_crm_extru_start(ruco=ruco_user)
    page_search_organization.open()
    page_search_organization.click_btn_create()
    modal_new_counterparty.entered_value_in_field_inn_name_address(inn_name_address)
    modal_new_counterparty.click_btn_create_new_one_in_ul_inn_name_address()
    modal_new_counterparty.choice_of_form(form_company)
    modal_new_counterparty.should_selected_name_form(form_company)
    modal_new_counterparty.filling_field_inn(inn_organization)
    modal_new_counterparty.click_btn_egrul()
    modal_new_counterparty.filling_field_jur_name(name_organization)
    modal_new_counterparty.choice_responsible_manager(responsible_manager)
    modal_new_counterparty.filling_field_name_for_search(name_organization)
    modal_new_counterparty.choice_player(player)
    modal_new_counterparty.filling_field_remark(
        value=remark)
    modal_new_counterparty.click_btn_save()

    # Страница поиска организаций
    page_search_organization.search_organization_by_inn(name_organization)
    page_search_organization.should_comment_by_name_organization(name_organization, remark)
    page_search_organization.open_organization_by_name(name_organization)

    # Страница организации
    page_organization.open_edit_in_new_tab()

    # Страница редактирования организации
    page_editing_organization.should_inn(inn_organization)
    page_editing_organization.should_search_title(name_organization)
    page_editing_organization.should_form(form_company)
    page_editing_organization.should_player(player)
    page_editing_organization.should_responsible_manager(responsible_manager)
    page_editing_organization.choice_direction(direction[0])
    page_editing_organization.should_directions(direction)

    page_editing_organization.choice_segment(segments_list[0])
    page_editing_organization.should_segment(segments_list)

    page_editing_organization.click_btn_plus_contact()
    page_editing_organization.choice_item_in_ul_plus_contact('Телефон')

    # Модалка редактирования телефона
    modal_edit_phone.should_header()
    modal_edit_phone.filling_phone(phone_num)
    modal_edit_phone.click_btn_save()

    page_editing_organization.should_phone_in_chapter_contacts(phone_num)
    page_editing_organization.click_btn_plus_contact()
    page_editing_organization.choice_item_in_ul_plus_contact('Адрес')

    # Модалка редактирования адреса
    modal_edit_address.should_header()
















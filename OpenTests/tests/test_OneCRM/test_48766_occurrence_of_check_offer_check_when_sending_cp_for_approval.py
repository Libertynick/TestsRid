import allure
import pytest
from selenium.common import TimeoutException

from config import TestEnvironment
from conftest import auth_extru_crm_from_authorized_page
from crm_pages.modal_new_kp.modal_new_kp import ModalNewKp
from crm_pages.object_page.object_page import ObjectPage, KpTab
from crm_pages.pq_page.pq_page import PqPage


@allure.feature('Создание КП в CRM')
@allure.story('Самовывоз. Стандартный заказ - Предоплата. Материалы. Проверка CheckOffer')
@pytest.mark.parametrize('article', ['003L0391R 1 065N0750GR 1 w488900 1 TDU1009575 1 065B2931R 1'])
@pytest.mark.stage
def test_48766_occurrence_of_check_offer_check_when_sending_cp_for_approval(browser, article, auth_crm_extru_start,
                                                                            auth_extru_crm_from_authorized_page):
    """Возникновение проверки checkOffer при отправке КП на согласование"""
    distr = TestEnvironment.DISTRIBUTOR_VODOKOMFORT_TST
    object_tst = TestEnvironment.LINK_OBJECT_IN_TST

    potential_mode = 'Частичная закупка'
    final_potential_mode = 'Полная закупка'
    expected_value_of_previous_potential_mode = 'предыдущее значение Частичная закупка'
    first_discount = 54.0
    second_discount = 61.0
    final_discount = 66.0

    article_list = article.split(' ')[::2]

    auth_crm_extru_start()

    # Страница Объекта
    page = ObjectPage(browser, object_tst)
    page.open()
    page.click_add_kp()

    page = ModalNewKp(browser, object_tst)
    page.potential_mode_selection(potential_mode)
    page.internal_course_toggle_switch_must_be_turned_on()
    page.choice_distributor(distr)
    page.choice_sap_code_main_contract()
    page.choice_final_buyer()
    page.there_must_be_an_advance_payment()
    page.there_should_be_standard_contractual_terms()
    page.internal_course_toggle_switch_must_be_turned_on()
    page.adding_codes(article)
    page.placing_a_discount_distributor_by_article(first_discount, article_list[0])
    page.placing_a_discount_distributor_by_article(second_discount, article_list[1])
    page.placing_a_discount_distributor_by_article(second_discount, article_list[2])
    page.placing_a_discount_distributor_by_article(second_discount, article_list[3])
    page.click_btn_save_pq()
    num_pq = page.store_num_pq_in_title()
    page.send_for_approval_from_modal_new_kp()
    page.modal_kp_has_not_been_pre_screened()

    page = ObjectPage(browser, object_tst)
    page.go_to_chapter_kp()

    page = KpTab(browser, object_tst)
    page.opening_pq_in_a_new_tab_by_number(num_pq)
    current_url = browser.current_url

    auth_extru_crm_from_authorized_page(url_page=current_url, name_user=TestEnvironment.LOGIN_CRM)

    page = PqPage(browser, current_url)
    page.open()

    page.click_btn_cancel_approval()
    page.placing_discounts_on_all_items_to_distributor(final_discount)
    page.click_btn_save_pq()

    try:
        page.send_for_approval_pq_page()
    except TimeoutException:
        page.there_should_be_a_modal_kp_did_not_pass_preliminary_check()

    page.check_text_partial_shipment_is_not_allowed_at_current_discount_level_in_modal()
    page.check_input_partial_shipment_to_full_is_true()
    page.click_btn_send_in_modal_kp_has_not_been_pre_screened()
    page.check_potential_mode(final_potential_mode)
    page.check_in_potential_mode_previous_value_identifier(expected_value_of_previous_potential_mode)

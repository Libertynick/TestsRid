import allure

from api_testing_project.services.crm_commerce.create_offer.api.api_create_offer import ApiCreateOffer


@allure.feature('CRM')
@allure.story('Возникновение согласований разного типа в КП отдела IC')
def test_50760_emergence_of_various_types_of_agreements_in_ic_departments_cp(
        browser,
        auth_crm_extru_start,
        emergence_of_different_types_of_agreements_in_kp
):
    """
    Возникновение согласований разного типа в КП отдела IC
    https://rucotfs.ridancorp.net/DanfossDev/CRM/_workitems/edit/50760
    """
    user_ruco = 'RUCO0761'  # Пинчук Роман

    null = None
    true = True
    false = False

    headers = {'userId': 'd1b31935-e3ea-4511-853b-440db3c412cc'}  # userId  Пинчук Роман
    req_create_offer = {
        "docType": "Order",
        "showPriceWithDiscount": false,
        "showDiscount": true,
        "currencyDate": "2025-05-27T00:00:00",
        "currency": "RUB",
        "exchangeRateType": "YRU",
        "userName": "RUCO0761",
        "personId": "36bd1176-b610-4d97-8319-1dcab62c4022",
        "usePromoCurrency": true,
        "passportId": "4DBB2A44-D895-468D-A51F-AE98B9B3D487",
        "specTypeId": "9F4A50CD-F5A9-4EF2-9440-34E932EA48A9",
        "specificationId": "D4D38CA0-D5C7-4771-9C22-1FA73997CBE1",
        "paymentTerms": "RU00",
        "surchargesPayment": "0",
        "surchargesConversion": 0,
        "payPercentBeforePlacingIntoProduction": 100,
        "isDraft": true,
        "isEndUserPQ": false,
        "purchaseType": "121B015A-E76D-4688-9BB6-2A56EC6DE2EF",
        "finalBuyerId": "e3f32e15-c185-424e-b6d4-55b08069e79b",
        "customerId": "aa890eff-7aa9-46c3-a887-29220f5a4274",
        "clientInn": "9705031050",
        "debtorAccount": "RT25-9705031050-HE",
        "currencySpecialFixation": true,
        "setContractDiscounts": true,
        "orderLines": [
            {
                "ODID": null,
                "materialCode": "042U001531R",
                "RequestedMaterialCode": "042U001531R",
                "quantity": 1,
                "lineNumber": 1,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "084Z8139R",
                "RequestedMaterialCode": "084Z8139R",
                "quantity": 1,
                "lineNumber": 2,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            },
            {
                "ODID": null,
                "materialCode": "060-121766R",
                "RequestedMaterialCode": "060-121766R",
                "quantity": 1,
                "lineNumber": 3,
                "usePromoCurrency": true,
                "discountPercent": 77,
                "endClientDiscountPercent": 0,
                "excludePosition": false,
                "useSpecialPrice": false,
                "lineType": "Material",
                "copiedFromId": null
            }
        ],
        "deliveryOptions": {
            "ConsigneeCode": null,
            "Condition": "RU",
            "DeliveryCost": 0,
            "ClientFinalDelivery": null,
            "ConsigneeContacts": null,
            "consigneeAgreementDelivery": {
                "SourceFiasId": "00000000-0000-0000-0000-000000000000",
                "Address": "",
                "PaidDelivery": false,
                "ConditionDescription": "Стандартные договорные условия",
                "INN": "6165144855"
            },
            "CostIncludedInOrder": false,
            "totalDeliveryWeight": 1.264,
            "endPoint": "ToTK",
            "deliveryType": "Pickup",
            "consigneeId": "00000000-0000-0000-0000-000000000000"
        },
        "deliveryOptionsHex": null,
        "deliveryOptionsProd": null,
        "deliveryOptionsDZRProd": null,
        "isExport": false,
        "validDays": 14,
        "source": null,
        "sellerId": "20C340FE-6AFF-486F-B248-FD8DBE2C93CD",
        "IsATOffer": false,
        "autoFromEngSpec": false,
        "isNew": true
    }

    type_of_agreement_visible_after_save = [
        'Скидки',
        'Незакрепленное КП',
        'Скидки ДД'
    ]  # Типы согласований после сохранения
    type_of_agreement_visible_after_save_after_change_condition = [
        'Незакрепленное КП',
        'Скидки',
        'Скидки ДД',
        'Доставка',
        'Предоплата',
        'Кредитный контроль',
        'Фиксированный курс'
    ]  # Типы согласований после изменений условий в КП

    expected_status_agreement = {
        'Незакрепленное КП ': 'в процессе',
        'Скидки': 'в процессе',
        'Скидки ДД': 'в процессе',
        'Доставка': 'в процессе',
        'Предоплата': 'в процессе',
        'Кредитный контроль': 'в процессе',
        'Фиксированный курс': 'в процессе'
    }  # Ожидаемые статусы у согласований

    delivery_type = 'Доставка на указанный адрес'

    # Создаем КП через Дапи
    api_create_offer = ApiCreateOffer()
    id_pq, num_pq = api_create_offer.create_offer(headers=headers, request=req_create_offer)
    print(id_pq, num_pq)

    auth_crm_extru_start(ruco=user_ruco)

    emergence_of_different_types_of_agreements_in_kp(
        id_pq=id_pq,
        num_pq=num_pq,
        type_of_agreement_visible_after_save=type_of_agreement_visible_after_save,
        type_of_agreement_visible_after_save_after_change_condition=type_of_agreement_visible_after_save_after_change_condition,
        delivery_type=delivery_type, expected_status_agreement=expected_status_agreement
    )

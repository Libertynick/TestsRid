import allure
import pytest

from base_page.base_page import BasePageCrm
from base_page.base_page_locators import BaseOpenLocators
from config import TestEnvironment
from crm_pages.pq_page.pq_page import PqPage
from crm_pages.search_pq_page.search_pq_page import SearchPq
from open_pages.cart_page.cart_page import CartPage
from open_pages.confirmation_page.confirmation_page import ConfirmationPage
from open_pages.design_condition_page.design_condition_page import DesignConditionPage
from open_pages.header.header_page import Header
from open_pages.main_page.main_page import MainPage
from open_pages.new_design_condition.new_design_condition_page import NewDesignCondition
from open_pages.order_details_page.order_details_page import OrderDetails
from open_pages.standart_order_page.standart_order_page import StandardOrderPage


@allure.feature('Создание проектного условия в Open')
@allure.story('Самовывоз. ПТО. Предоплата')
@pytest.mark.xdist_group(name="design condition")  # группа для параллельного запуска
@pytest.mark.parametrize('article', ['w488900 5 878139 4'])
@pytest.mark.stage
@pytest.mark.autostart
def test_26633_pto_cart_creating_a_design_condition_in_open(browser, article, auth_extru_crm_from_authorized_page,
                                                            auth_crm_extru_start, agreement_on_all_conditions_extru):
    """26663 Корзина ПТО Создание проектного условия в Open"""
    comment = 'ТЕСТИРОВАНИЕ!!!\ntest_selenium_web_ui'
    value_for_increasing_discount = 7  # Значение для увеличения скидки
    type_delivery = 'Самовывоз'
    num_object = '1139467'

    page = MainPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.open()
    page.authorization_from_main_page(TestEnvironment.LOGIN_TST_BURNYASHEVA, TestEnvironment.PASSWORD_TST_BURNYASHEVA)

    # Переход в Корзину
    page = Header(browser, TestEnvironment.LINK_OPEN_TST)
    page.click_basket()

    # Действия в корзине
    page = CartPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.choice_of_client_number()
    page.click_empty_trash()
    page.type_product_in_input(article)
    page.click_add_button()
    price_cart = page.store_price()
    page.click_continue_button()

    # Стандартный заказ
    page = StandardOrderPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.should_h1_standard_order()
    page.click_new_project()

    # Новое Проектное условие
    page = NewDesignCondition(browser, TestEnvironment.LINK_OPEN_TST)
    page.there_must_be_an_advance_payment()
    price_new_design_condition = page.store_price_confirmation()
    page.should_be_equal_prices(price_cart, price_new_design_condition)
    page.type_comment(comment)
    page.choose_name_object(num_object)
    page.choose_eng_section()
    page.choose_end_buyer()
    page.button_input_gcm()
    page.input_new_gcm(value_for_increasing_discount)
    discounts_in_gcm_tab = page.saving_a_list_with_discounts_in_gcm_tab()
    page.click_on_button_confirm_entered_gcm()

    requested_discount_on_page_design_condition = page.saving_requested_discounts_on_page()
    with allure.step('Сравнение скидок на странице Проектное условие в Опене со скидками, '
                     'которые ввели в модалке внесения скидок по ГЦМ'):
        assert discounts_in_gcm_tab[0] in requested_discount_on_page_design_condition, \
            f'Запрашиваемые Скидки на странице Проектное условие - ({requested_discount_on_page_design_condition}) ' \
            f'не равны введенным скидкам в модалке Внесение скидок по ГЦМ - ({discounts_in_gcm_tab})'

    price_new_design_condition_after_applying_discounts = page.store_price_confirmation()
    page.click_button_confirm()
    page.transition_to_created_design_condition()

    # Проектное условие
    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    design_condition_discounts = page.store_all_discounts_on_the_design_condition_page()
    with allure.step('Сравнение скидок на странице Проектное условие (PQ) в Опене со скидками при '
                     'создании проектного условия на странице Новое проектное условие'):
        assert requested_discount_on_page_design_condition == design_condition_discounts, \
            f'Скидки на странице Проектное условие (PQ) - ({design_condition_discounts}) не равны запрашиваемым скидкам ' \
            f'на странице Новое проектное условие - ({requested_discount_on_page_design_condition})'

    total_price_on_design_condition = page.saving_the_final_cost_rub_on_the_design_condition_page()
    with allure.step('Сравнение итоговой стоимости на странице Проектное условие (PQ) с итоговой стоимостью на '
                     'странице Новое проектное условие'):
        assert abs(total_price_on_design_condition - price_new_design_condition_after_applying_discounts) <= 2, \
            f'Итоговая стоимость на странице Проектное условие - ({total_price_on_design_condition}) не равна стоимости ' \
            f'на странице Новое проектное условие - ({price_new_design_condition_after_applying_discounts})'

    page.delivery_method_must_be_pick_up()

    page.availability_display_check()
    created_num_pq = page.store_created_num_pq()
    print(created_num_pq, 'Номер созданного PQ')
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)

    #  Переход в crm для согласования
    page = BasePageCrm(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    browser.execute_script("window.open(arguments[0])", TestEnvironment.LINK_SEARCH_PQ_TST)
    page.switching_window(-1)
    auth_crm_extru_start(ruco=TestEnvironment.LOGIN_CRM)
    page.open()

    page = SearchPq(browser, TestEnvironment.LINK_CRM_TST)
    window_search_pq_crm = browser.current_window_handle  # Вкладка поиска PQ
    page.search_pq(created_num_pq)
    page.go_to_pq_by_number_in_new_tab(created_num_pq)

    # Страница PQ
    agreement_on_all_conditions_extru()
    url_pq = browser.current_url
    auth_extru_crm_from_authorized_page(url_page=url_pq, name_user=TestEnvironment.LOGIN_CRM)

    page = PqPage(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    total_price_crm = page.saving_the_final_amount_rub_after_agreement()
    with allure.step('Сравнение итоговой стоимости на странице PQ в СРМ с итоговой суммой на странице '
                     'Проектное условие в Опен'):
        assert total_price_crm == total_price_on_design_condition, \
            f'Сумма на странице PQ в crm - ({total_price_crm}) не равна сумме на странице Проектное условие в Опен - ' \
            f'({total_price_on_design_condition})'

    discounts_in_pq_crm = page.store_all_discounts()
    with allure.step('Сравнение скидок на странице PQ в СРМ со скидками на странице Новое проектное условие в Опене'):
        assert discounts_in_pq_crm == design_condition_discounts, \
            f'Скидки на странице PQ в crm - ({discounts_in_pq_crm}) не соответствуют скидкам на странице Проектное ' \
            f'условие - ({design_condition_discounts})'

    # Переход на вкладку Опен - Проектное условие
    page.switching_window(0)
    browser.refresh()
    page.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)

    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.payment_condition_must_be_advance_payment()
    page.availability_display_check()
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)
    page.click_printing_forms()
    page.checking_commercial_offer_ridan_download()
    page.click_button_order()

    # Страница Подтверждение
    page = ConfirmationPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.checkbox_shipment_only_when_fully_loaded_must_be_selected()
    page.must_be_prepaid()
    page.checking_the_selected_delivery(type_delivery)
    page.checking_the_address_of_the_warehouse_during_self_delivery_pto()

    discounts_confirmation_page = page.store_all_discounts_on_the_confirmation_page()
    with allure.step('Сравнение скидок на странице Подтверждение в Опене со скидками на странице PQ в СРМ'):
        assert discounts_confirmation_page == discounts_in_pq_crm, \
            f'Скидки на странице Подтверждение - ({discounts_confirmation_page}) не равны скидкам на странице PQ в CRM - ' \
            f'({discounts_in_pq_crm})'

    total_price_confirmation_page = page.store_total_cost_on_the_confirmation_page()
    with allure.step('Сравнение итоговой стоимости на странице Подтверждение в Опене с итоговой стоимостью на странице'
                     ' PQ в СРМ'):
        assert total_price_confirmation_page - total_price_crm < 2, \
            f'Итоговая стоимость на странице Подтверждение - ({total_price_confirmation_page}) не равна стоимости на ' \
            f'странице PQ в crm - ({total_price_crm})'

    page.input_comment()
    page.save_to_excel(created_num_pq)
    page.click_button_confirm()
    page.dkp_link_open_check()
    page.click_on_the_button_to_return_to_pq()

    # Страница Проектное условие
    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.waiting_to_create_invoices()
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)
    page.click_printing_forms()
    page.checking_commercial_offer_ridan_download()

    amount_of_orders_created = page.saving_the_amount_in_created_orders()
    with allure.step('Сравнение сумм итоговой стоимости созданных заказов с итоговой стоимостью на странице '
                     'Подтверждение в Опене'):
        assert abs(amount_of_orders_created - total_price_confirmation_page) < 2, \
            f'Сумма созданных заказов - ({amount_of_orders_created}) не равна стоимости на странице Подтверждение - ' \
            f'({total_price_confirmation_page})'

    page.go_to_order(1)

    # Страница Детали заказа
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.data_display_check()
    page.payment_condition_must_be_advance_payment()
    num_order = page.store_num_order()
    print(num_order, 'Номер заказа')
    price_order = page.store_price_order()
    discounts_order = page.sve_all_discounts()
    page.checking_printing_forms_download(num_order)
    page.check_delivery_method(type_delivery)

    browser.switch_to.window(window_search_pq_crm)

    # Страница поиска заказа в crm
    page = SearchPq(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    page.search_order(num_order)
    page.go_to_order(num_order)

    #  Страница заказа
    page = PqPage(browser, TestEnvironment.LINK_CRM_TST)
    page.payment_condition_must_be_advance_payment()
    page.terms_of_delivery_must_be_standard_contractual_terms()
    price_order_crm = page.store_price_crm_order()
    with allure.step(
            'Сравнение стоимости заказа на странице заказа в срм со стоимостью на странице Детали заказа в Опене'):
        assert price_order_crm == float(price_order), \
            f'Стоимость - ({price_order_crm}) заказа {num_order} на странице Заказа в crm не равна стоимости - ' \
            f'({price_order}) заказа - ({num_order}) на странице Детали заказа в Опене'

    all_discounts_crm_order = page.store_all_discounts()
    with allure.step(
            'Сравнение скидок в заказе на странице заказа в срм со скидками на странице Детали заказа в Опене'):
        assert all_discounts_crm_order == discounts_order, \
            f'Скидки - {all_discounts_crm_order}) на странице заказа {num_order} в crm не соответствуют скидкам - ' \
            f'{discounts_order} заказа {num_order} на странице Детали заказа в Опене'

import allure
import pytest

from base_page.base_page import BasePageCrm
from base_page.base_page_locators import BaseOpenLocators
from config import TestEnvironment
from crm_pages.pq_page.pq_page import PqPage
from crm_pages.search_pq_page.search_pq_page import SearchPq
from open_pages.cart_page.cart_page import CartPage
from open_pages.confirmation_page.confirmation_page import ConfirmationPage
from open_pages.design_condition_page.design_condition_page import DesignConditionPage
from open_pages.header.header_page import Header
from open_pages.main_page.main_page import MainPage
from open_pages.new_design_condition.new_design_condition_page import NewDesignCondition
from open_pages.order_details_page.order_details_page import OrderDetails
from open_pages.standart_order_page.standart_order_page import StandardOrderPage

ADDRESS_PICKUP = 'Московская обл., Истра, деревня Лешково, д 217'
value_for_increasing_discount = 3  # Значение для увеличения скидки


@allure.feature('Создание проектного условия в Open')
@allure.story('Самовывоз.Материалы + ПТО. Предоплата')
@pytest.mark.xdist_group(name="design condition")  # группа для параллельного запуска
@pytest.mark.parametrize('article', ['003L0145R 10 w488900 2'])
@pytest.mark.stage
def test_26796_creation_of_design_conditions_for_materials_and_pto_standard_contractual_terms(browser, article,
                                                                                              auth_extru_crm_from_authorized_page,
                                                                                              auth_crm_extru_start,
                                                                                              agreement_on_all_conditions_extru):
    """Создание проектного условия на материалы стандартные договорные условия"""
    num_object = '1139467'

    # Действия на Главной странице
    page = MainPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.open()
    page.authorization_from_main_page(TestEnvironment.LOGIN_TST_BURNYASHEVA, TestEnvironment.PASSWORD_TST_BURNYASHEVA)

    # Переход в Корзину
    page = Header(browser, TestEnvironment.LINK_OPEN_TST)
    page.click_basket()

    # Действия в корзине
    page = CartPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.choice_of_client_number()
    page.click_empty_trash()
    page.type_product_in_input(article)
    page.click_add_button()
    price_cart = page.store_price()
    # print(price_cart, 'Стоимость в Корзине')
    page.click_continue_button()

    # Стандартный заказ
    page = StandardOrderPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.should_h1_standard_order()
    page.click_new_project()

    # Новое Проектное условие
    page = NewDesignCondition(browser, TestEnvironment.LINK_OPEN_TST)
    page.there_must_be_an_advance_payment()
    price_new_design_condition = page.store_price_confirmation()
    # print(price_new_design_condition, 'Стоимость на странице Новое Проектное условие')
    page.should_be_equal_prices(price_cart, price_new_design_condition)
    comment = 'ТЕСТИРОВАНИЕ!!!\ntest_selenium_web_ui'
    page.type_comment(comment)
    page.choose_name_object(num_object)
    page.choose_eng_section()
    page.choose_end_buyer()
    page.button_input_gcm()
    page.input_new_gcm(value_for_increasing_discount)
    discounts_in_gcm_tab = page.saving_a_list_with_discounts_in_gcm_tab()
    # print(discounts_in_gcm_tab, 'Скидки в модалке внесения скидок по ГЦМ')
    page.click_on_button_confirm_entered_gcm()
    requested_discount_on_page_design_condition = page.saving_requested_discounts_on_page()
    # print(requested_discount_on_page_design_condition, 'Запрашиваемые Скидки на странице Новое Проектное условие')
    assert requested_discount_on_page_design_condition == discounts_in_gcm_tab, \
        f'Запрашиваемые Скидки на странице Проектное условие - ({requested_discount_on_page_design_condition}) ' \
        f'не равны введенным скидкам в модалке Внесение скидок по ГЦМ - ({discounts_in_gcm_tab})'
    price_new_design_condition_after_applying_discounts = page.store_price_confirmation()
    # print(price_new_design_condition_after_applying_discounts, 'Стоимость на странице Новое Проектное условие')
    page.click_button_confirm()
    page.transition_to_created_design_condition()

    #  проектное условие
    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    design_condition_discounts = page.store_all_discounts_on_the_design_condition_page()
    # print(design_condition_discounts, 'Скидки на странице Проектное условие')
    design_condition_discounts.sort()
    requested_discount_on_page_design_condition.sort()
    assert design_condition_discounts == requested_discount_on_page_design_condition, \
        f'Скидки на странице Проектное условие (PQ) - ({design_condition_discounts}) не равны запрашиваемым скидкам ' \
        f'на странице Новое проектное условие - ({requested_discount_on_page_design_condition})'
    total_price_on_design_condition = page.saving_the_final_cost_rub_on_the_design_condition_page()
    # print(total_price_on_design_condition, 'Итоговая стоимость на странице Проектное условие')
    assert abs(total_price_on_design_condition - price_new_design_condition_after_applying_discounts) <= 2, \
        f'Итоговая стоимость на странице Проектное условие - ({total_price_on_design_condition}) не равна стоимости ' \
        f'на странице Новое проектное условие - ({price_new_design_condition_after_applying_discounts})'
    page.availability_display_check()
    created_num_pq = page.store_created_num_pq()
    print(created_num_pq, 'Номер созданного PQ')
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)

    #  Переход в crm для согласования
    page = BasePageCrm(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    browser.execute_script("window.open(arguments[0])", TestEnvironment.LINK_SEARCH_PQ_TST)
    page.switching_window(-1)
    auth_crm_extru_start(TestEnvironment.LOGIN_CRM)
    page.open()

    page = SearchPq(browser, TestEnvironment.LINK_CRM_TST)
    window_search_pq_crm = browser.current_window_handle  # Вкладка поиска PQ
    page.search_pq(created_num_pq)
    page.go_to_pq_by_number_in_new_tab(created_num_pq)

    # Страница PQ
    agreement_on_all_conditions_extru()

    url_pq = browser.current_url
    auth_extru_crm_from_authorized_page(url_page=url_pq, name_user=TestEnvironment.LOGIN_CRM)

    # Страница PQ
    page = PqPage(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    total_price_crm = page.saving_the_final_amount_rub_after_agreement()
    # print(total_price_crm, 'Итоговая сумма в crm')
    assert total_price_crm == total_price_on_design_condition, \
        f'Сумма на странице PQ в crm - ({total_price_crm}) не равна сумме на странице Проектное условие в Опен - ' \
        f'({total_price_on_design_condition})'

    discounts_in_pq_crm = page.store_all_discounts()
    # print(discounts_in_pq_crm, 'Скидки на странице PQ в crm')
    assert discounts_in_pq_crm == design_condition_discounts, \
        f'Скидки на странице PQ в crm - ({discounts_in_pq_crm}) не соответствуют скидкам на странице Проектное ' \
        f'условие - ({design_condition_discounts})'

    # Переход на вкладку Опен - Проектное условие
    page.switching_window(0)
    browser.refresh()
    page.waiting_for_loader_processing_on_page(BaseOpenLocators.LOCATOR_SPINNER_NO_TEXT)

    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.payment_condition_must_be_advance_payment()
    page.availability_display_check()
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)
    page.click_printing_forms()
    page.checking_commercial_offer_ridan_download()
    page.click_button_order()

    # Страница Подтверждение
    page = ConfirmationPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.checkbox_shipment_only_when_fully_loaded_must_be_selected()
    page.must_be_prepaid()

    discounts_confirmation_page = page.store_all_discounts_on_the_confirmation_page()
    # print(discounts_confirmation_page, f'Скидки на странице Подтверждение')
    assert discounts_confirmation_page == discounts_in_pq_crm, \
        f'Скидки на странице Подтверждение - ({discounts_confirmation_page}) не равны скидкам на странице PQ в CRM - ' \
        f'({discounts_in_pq_crm})'

    total_price_confirmation_page = page.store_total_cost_on_the_confirmation_page()
    # print(total_price_confirmation_page, f'Итоговая стоимость на странице Подтверждение')
    assert total_price_confirmation_page - total_price_crm < 2, \
        f'Итоговая стоимость на странице Подтверждение - ({total_price_confirmation_page}) не равна стоимости на ' \
        f'странице PQ в crm - ({total_price_crm})'

    page.input_comment()
    page.save_to_excel(created_num_pq)
    page.click_button_confirm()
    page.dkp_link_open_check()
    page.click_on_the_button_to_return_to_pq()

    # Страница Проектное условие
    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.waiting_to_create_invoices()
    page.click_printing_forms()
    page.checking_export_to_excel_download(created_num_pq)
    page.click_printing_forms()
    page.checking_commercial_offer_ridan_download()

    amount_of_orders_created = page.saving_the_amount_in_created_orders()
    # print(amount_of_orders_created, 'Сумма созданных заказов')
    assert abs(amount_of_orders_created - total_price_confirmation_page) < 2, \
        f'Сумма созданных заказов - ({amount_of_orders_created}) не равна стоимости на странице Подтверждение - ' \
        f'({total_price_confirmation_page})'

    page.go_to_order(1)

    # Страница Детали 1-ого заказа
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.data_display_check()
    page.payment_condition_must_be_advance_payment()
    num_order_1 = page.store_num_order()
    print(num_order_1, 'Номер заказа 1')
    price_order_1 = page.store_price_order()
    # print(price_order_1, f'Стоимость заказа {num_order_1}')
    discounts_order_1 = page.sve_all_discounts()
    # print(discounts_order_1, f'Скидки на странице заказа - {num_order_1}')
    page.checking_printing_forms_download(num_order_1)

    # Переход на вкладку Проектное условие
    page.switching_window(0)
    page = DesignConditionPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.go_to_order(2)

    #  Страница Детали 2-ого заказа
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.data_display_check()
    page.payment_condition_must_be_advance_payment()
    num_order_2 = page.store_num_order()
    print(num_order_2, 'Номер заказа 2')
    price_order_2 = page.store_price_order()
    # print(price_order_2, f'Стоимость заказа {num_order_2}')
    discounts_order_2 = page.sve_all_discounts()
    # print(discounts_order_2, f'Скидки на странице заказа - {num_order_2}')
    page.checking_printing_forms_download(num_order_2)

    browser.switch_to.window(window_search_pq_crm)

    # Страница поиска заказа в crm
    page = SearchPq(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    page.search_order(num_order_1)
    page.go_to_order(num_order_1)

    #  Страница 1-ого заказа
    page = PqPage(browser, TestEnvironment.LINK_CRM_TST)
    page.payment_condition_must_be_advance_payment()
    price_order_crm_1 = page.store_price_crm_order()
    # print(price_order_crm_1, f'Стоимость заказа в ДКП crm {num_order_1}')
    assert price_order_crm_1 == float(price_order_1), \
        f'Стоимость - ({price_order_crm_1}) заказа {num_order_1} на странице Заказа в crm не равна стоимости - ' \
        f'({price_order_1}) заказа - ({num_order_1}) на странице Детали заказа в Опене'

    all_discounts_crm_order_1 = page.store_all_discounts()
    # print(all_discounts_crm_order_1, f'Скидки на странице заказа в crm - {num_order_1}')
    assert all_discounts_crm_order_1 == discounts_order_1, \
        f'Скидки - {all_discounts_crm_order_1}) на странице заказа {num_order_1} в crm не соответствуют скидкам - ' \
        f'{discounts_order_1} заказа {num_order_1} на странице Детали заказа в Опене'

    browser.switch_to.window(window_search_pq_crm)

    # Страница поиска заказа в crm
    page = SearchPq(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    page.search_order(num_order_2)
    page.go_to_order(num_order_2)

    #  Страница 2-ого заказа
    page = PqPage(browser, TestEnvironment.LINK_CRM_TST)
    page.payment_condition_must_be_advance_payment()
    price_order_crm_2 = page.store_price_crm_order()
    # print(price_order_crm_2, f'Стоимость заказа в ДКП crm {num_order_2}')
    assert price_order_crm_2 == float(price_order_2), \
        f'Стоимость - ({price_order_crm_2}) заказа {num_order_2} на странице Заказа в crm не равна стоимости - ' \
        f'({price_order_2}) заказа - ({num_order_2}) на странице Детали заказа в Опене'

    all_discounts_crm_order_2 = page.store_all_discounts()
    # print(all_discounts_crm_order_2, f'Скидки на странице заказа в crm - {num_order_2}')
    assert all_discounts_crm_order_2 == discounts_order_2, \
        f'Скидки - {all_discounts_crm_order_2}) на странице заказа {num_order_2} в crm не соответствуют скидкам - ' \
        f'{discounts_order_2} заказа {num_order_2} на странице Детали заказа в Опене'

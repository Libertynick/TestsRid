import allure
import pytest

from config import TestEnvironment
from conftest import auth_crm_extru_start
from crm_pages.pq_page.pq_page import PqPage
from crm_pages.search_pq_page.search_pq_page import SearchPq
from open_pages.cart_page.cart_page import CartPage
from open_pages.header.header_page import Header
from open_pages.main_page.main_page import MainPage
from open_pages.order_details_page.order_details_page import OrderDetails, ModalWindowCancelOrder
from open_pages.standart_order_page.standart_order_page import StandardOrderPage

ARTICLE = ['065B8307R 10 w488900 1']
ADDRESS_PICKUP = 'Московская обл., Истра, деревня Лешково, д 217'


@allure.feature('Создание заказа из корзины')
@allure.story('Раздельные условия доставки. Материалы (самовывоз) + ПТО (доставка на указанный адрес). '
              'Стандартный заказ Предоплата')
@pytest.mark.xdist_group(name="open")  # группа для параллельного запуска
@pytest.mark.parametrize('article', ['065B8307R 10 w488900 1'])
@pytest.mark.stage
def test_26463_creation_kp_material_pto_delivery(browser, article, auth_crm_extru_start):
    """Создание КП материал самовывоз + ПТО доставка на адрес"""
    # Действия на Главной странице
    page = MainPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.open()
    page.authorization_from_main_page(TestEnvironment.LOGIN_TST_VODOKOMFORT, TestEnvironment.PASSWORD_TST_VODOKOMFORT)

    # Переход в Корзину
    page = Header(browser, TestEnvironment.LINK_OPEN_TST)
    page.click_basket()

    # Действия в корзине
    page = CartPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.choice_of_client_number()
    page.click_empty_trash()
    page.type_product_in_input(article)
    page.click_add_button()
    price_cart = page.store_price()
    # print(price_cart, 'price_cart---')
    page.click_continue_button()

    # Действия на странице Подтверждение
    page = StandardOrderPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.should_h1_standard_order()
    price_confirmation = page.store_price_material_pto()
    # print(price_confirmation, 'price_confirmation---')
    page.should_be_equal_prices(price_cart, price_confirmation)
    page.choice_of_payment_terms_prepayment()
    page.choice_of_delivery_method_pickup()
    page.should_be_the_default_address(ADDRESS_PICKUP)

    page.choice_of_delivery_to_address_method_pickup_pto()
    delivery_address = 'г Иваново, ул Кузнецова, д 123'
    page.choice_address_pto(delivery_address)
    page.button_cost_delivery()
    cost_delivery = page.save_cost_delivery_pto()
    print(f'Стоимость доставки с НДС', cost_delivery)
    comment = 'Автотесты!!!\ntest_selenium_web_ui'
    page.type_comment(comment)

    page.click_confirmation_button()

    # Страница с созданными заказами
    page = StandardOrderPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.go_to_created_order(1)

    # Страница детали первого заказа
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.waiting_for_account_creation()
    page.delivery_location_check_pto()
    price_order_1 = float(page.store_price_order())
    num_order_1 = page.store_num_order()
    print(f'{num_order_1} - номер 1-ого заказа')
    page.checking_printing_forms_download(num_order_1)

    # Возвращение на страницу с созданными заказами
    page = ModalWindowCancelOrder(browser, TestEnvironment.LINK_OPEN_TST)
    page.back_page()

    # Страница с созданными заказами
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.waiting_open_page_reference_number()
    page = StandardOrderPage(browser, TestEnvironment.LINK_OPEN_TST)
    page.go_to_created_order(2)

    # Страница детали второго заказа
    page = OrderDetails(browser, TestEnvironment.LINK_OPEN_TST)
    page.waiting_for_account_creation()
    page.payment_condition_must_be_advance_payment()
    page.data_display_check()
    page.delivery_location_check_pto()
    price_order_2 = float(page.store_price_order())
    num_order_2 = page.store_num_order()
    print(f'{num_order_2} - номер 2-ого заказа')
    # print(price_order_2, f'Стоимость заказа {num_order_2} в деталях заказа в Опене')
    page.checking_printing_forms_download(num_order_2)

    # Переход в crm для сверки стоимости первого заказа
    auth_crm_extru_start(ruco=TestEnvironment.LOGIN_CRM)

    page = SearchPq(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    page.open()
    page.search_order(num_order_1)
    page.go_to_order(num_order_1)

    page = PqPage(browser, TestEnvironment.LINK_CRM_TST)
    price_order_crm_1 = float(page.store_price_crm_order())
    # print(price_order_crm_1, f'Стоимость заказа в ДКП crm {num_order_1}')
    page.verify_price_crm_with_price_open(price_order_crm_1, price_order_1)
    page = PqPage(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    transportation_cost = page.saving_delivery_costs_in_rubles()
    page.delivery_check_pto_crm(cost_delivery, transportation_cost)

    # Поиск второго заказа
    page = SearchPq(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    page.open()
    page.search_order(num_order_2)
    page.go_to_order(num_order_2)

    page = PqPage(browser, TestEnvironment.LINK_CRM_TST)
    page.payment_condition_must_be_advance_payment()
    price_order_crm_2 = float(page.store_price_crm_order())
    # print(price_order_crm_2, f'Стоимость заказа в ДКП crm {num_order_2}')
    page.verify_price_crm_with_price_open(price_order_crm_2, price_order_2)
    page = PqPage(browser, TestEnvironment.LINK_SEARCH_PQ_TST)
    transportation_cost = page.saving_delivery_costs_in_rubles()
    page.delivery_check_pto_crm(cost_delivery, transportation_cost)

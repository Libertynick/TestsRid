import allure
import pytest

from base_page.base_page import BasePageCrm
from base_page.raise_exceptions import MyTimeoutException
from config import TestEnvironment
from crm_pages.header_page.header_page import HeaderPage
from crm_pages.journal_ik_page.journal_ik_page import JournalIkPage, PqPageJournalIk
from crm_pages.modal_new_kp.modal_new_kp import ModalNewKp
from crm_pages.object_page.object_page import ObjectPage
from crm_pages.pq_page.pq_page import PqPage
from crm_pages.search_pq_page.search_pq_page import SearchPq


@allure.feature('Создание заказа из PQ')
@allure.story('Создание КП с защищенным расчетом - для незакрепленного дистрибьютора')
@pytest.mark.parametrize('article', ['w204010133'])
def test_50787_creation_of_commercial_agreement_with_protected_calculation_for_unassigned_distributor(browser, article,
                                                                                                      auth_extru_crm_from_authorized_page,
                                                                                                      auth_crm_extru_start,
                                                                                                      agreement_on_all_conditions_extru):
    """Создание КП с защищенным расчетом - для незакрепленного дистрибьютора"""
    object_tst = TestEnvironment.OBJECT_MULTIFUNCTIONAL_FACILITY_FOR_PUBLIC_SERVICES
    search_page = TestEnvironment.LINK_SEARCH_PQ_TST
    login_crm = TestEnvironment.LOGIN_CRM

    page_base = BasePageCrm(browser, object_tst)
    page_object = ObjectPage(browser, object_tst)
    page_modal_new_kp = ModalNewKp(browser, object_tst)
    page_header = HeaderPage(browser, object_tst)
    page_journal_ik = JournalIkPage(browser, object_tst)
    page_pq_page_journal_ik = PqPageJournalIk(browser, object_tst)
    page_search_pq = SearchPq(browser, search_page)
    page_pq = PqPage(browser, object_tst)

    final_buyer = 'Леднев Григорий'  # Конечный покупатель
    expected_error_msg = 'Для отправки на согласование КП необходимо дождаться согласования защищённого расчёта ИК-ом.\nСохраните КП для отправки уведомления ответственному ИК.'

    auth_crm_extru_start(ruco='RUCO2573')
    page_base.open()

    # Страница Объекта
    page_object.click_add_kp()

    # Модалка создания КП
    page_modal_new_kp.choice_distributor()
    page_modal_new_kp.choice_sap_code_main_contract()
    page_modal_new_kp.choice_final_buyer(final_buyer=final_buyer)
    page_modal_new_kp.adding_codes(article)
    page_modal_new_kp.check_that_calculation_has_flag_protected_calculation(article)
    # time.sleep(30)
    try:
        page_modal_new_kp.send_for_approval_from_modal_new_kp()
    except MyTimeoutException:
        print('Отловили исключение, т.к. кп не должно уходить на согласование')
    page_modal_new_kp.check_that_pop_up_error_is_one()
    page_modal_new_kp.check_message_in_popup_error(expected_error_msg)
    num_pq = page_modal_new_kp.store_num_pq_in_title()
    print(num_pq)
    page_modal_new_kp.checking_that_calculation_has_flag_awaiting_ik_approval(article, num_pq)
    page_modal_new_kp.check_btn_on_approval_is_disabled()
    page_modal_new_kp.close_modal_new_kp()

    current_rl = browser.current_url
    auth_extru_crm_from_authorized_page(url_page=current_rl, name_user=login_crm)

    # Переход в Журнал ИК
    page_header.click_btn_to_ridan()
    page_header.click_btn_journal_ik()
    window_journal_ik = browser.current_window_handle

    # Журнал ИК
    name_agreement = page_journal_ik.save_name_agreement_by_num_pq(num_pq)
    list_name_agreement = [name_agreement]
    print(list_name_agreement)

    current_url = browser.current_url
    auth_extru_crm_from_authorized_page(url_page=current_url, name_user=list_name_agreement[0])

    page_journal_ik.click_btn_agreement_by_num_pq(num_pq)
    # page_pq_page_journal_ik.activation_of_all_access_to_printed_form_and_technical_details_of_calculation()
    # page_pq_page_journal_ik.activation_of_price_access_for_all_calculations()
    page_pq_page_journal_ik.click_btn_max_all_calculations(article)
    page_pq_page_journal_ik.click_btn_approve(num_pq)

    # Переход во вкладку Журнал ИК
    browser.switch_to.window(window_journal_ik)
    page_journal_ik.refresh()
    page_journal_ik.checking_that_pq_is_not_on_list(num_pq)

    # Переход в поиск КП и в само КП
    auth_extru_crm_from_authorized_page(current_url, login_crm)
    page_search_pq.open()
    page_search_pq.search_pq(num_pq)
    page_search_pq.go_to_pq_by_number_in_new_tab(num_pq)
    page_pq.check_calculation_does_not_have_flag_pending_ik_approval(article, num_pq)
    page_pq.send_for_approval_pq_page()
    page_pq.create_account()
    page_pq.waiting_for_account_creation()
